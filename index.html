<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直播源检测工具</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Arial,sans-serif;background:#f5f5f5;height:100vh;display:flex;flex-direction:column}
        .container{flex:1;max-width:1200px;margin:0 auto;background:white;padding:15px;border-radius:8px;display:flex;flex-direction:column;height:100%;width:100%}
        h1{color:#333;text-align:center;margin:10px 0 20px;font-size:1.5rem}
        
        /* 视频预览框样式 */
        .video-preview-container {
            margin: 15px 0;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            display: none;
            flex-direction: column;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            max-height: 70vh;
            min-height: 300px;
        }
        
        .video-preview-container.active {
            display: flex;
        }
        
        .video-preview-header {
            background: #333;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .video-preview-title {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            font-size: 1.1rem;
        }
        
        .close-preview-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 15px;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .close-preview-btn:hover {
            background: #c82333;
        }
        
        #previewVideo {
            width: 100%;
            height: auto;
            max-height: calc(70vh - 60px);
            background: #000;
            object-fit: contain;
        }
        
        /* 网络导入区域样式 */
        .network-import {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .network-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .network-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .network-btn {
            padding: 10px 15px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            white-space: nowrap;
        }
        
        .network-btn:hover {
            background: #138496;
        }
        
        .network-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .network-status {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
            min-height: 20px;
        }
        
        .network-loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #007bff;
        }
        
        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .upload-area{border:2px dashed #ccc;padding:20px;text-align:center;margin:0 0 15px;cursor:pointer;border-radius:6px;transition:all 0.3s}
        .upload-area:hover{border-color:#4CAF50;background-color:#f9f9f9}
        .file-input{display:none}
        .channel{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;min-height:44px}
        .channel-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:10px;display:flex;align-items:center;gap:8px}
        .channel-checkbox{margin-right:8px;width:16px;height:16px;cursor:pointer}
        
        /* 播放按钮样式 */
        .play-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
        }
        
        .play-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .play-btn.playing {
            background: #dc3545;
        }
        
        .play-btn.playing:hover {
            background: #c82333;
        }
        
        .play-btn i {
            font-style: normal;
            margin-right: 4px;
        }
        
        .resolution-badge{font-size:0.7rem;padding:1px 6px;border-radius:4px;font-weight:600;white-space:nowrap;min-width:40px;text-align:center;border:1px solid transparent}
        .resolution-4k{background:linear-gradient(135deg, #8A2BE2, #9370DB);color:white;border-color:#8A2BE2}
        .resolution-2k{background:linear-gradient(135deg, #4169E1, #6495ED);color:white;border-color:#4169E1}
        .resolution-1080p{background:linear-gradient(135deg, #1E90FF, #87CEFA);color:white;border-color:#1E90FF}
        .resolution-720p{background:linear-gradient(135deg, #32CD32, #90EE90);color:white;border-color:#32CD32}
        .resolution-480p{background:linear-gradient(135deg, #FFD700, #FFEC8B);color:#8B4513;border-color:#FFD700}
        .resolution-360p{background:linear-gradient(135deg, #FFA500, #FFD700);color:#8B4513;border-color:#FFA500}
        .resolution-240p{background:linear-gradient(135deg, #FF4500, #FF6347);color:white;border-color:#FF4500}
        .resolution-sd{background:linear-gradient(135deg, #A9A9A9, #D3D3D3);color:#333;border-color:#A9A9A9}
        .resolution-unknown{background:linear-gradient(135deg, #808080, #B0B0B0);color:white;border-color:#808080}
        .channel-url{color:#666;font-size:0.85rem;margin-left:10px;font-family:monospace;max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .status{padding:5px 10px;border-radius:4px;margin-left:10px;font-size:0.85rem;white-space:nowrap}
        .valid{background:#d4edda;color:#155724}
        .invalid{background:#f8d7da;color:#721c24}
        .checking{background:#fff3cd;color:#856404}
        .waiting{background:#f0f0f0;color:#666}
        .time{margin-left:10px;color:#666;font-size:0.8rem;white-space:nowrap}
        .stats{margin:10px 0;font-weight:bold;font-size:0.9rem;padding:8px;background:#f8f9fa;border-radius:4px}
        .stats-btn{background:#6c757d;color:white;border:none;padding:3px 8px;cursor:pointer;border-radius:3px;font-size:0.85rem;margin:0 2px;transition:all 0.2s}
        .stats-btn:hover{opacity:0.9;transform:translateY(-1px)}
        .stats-btn.active{box-shadow:0 0 0 2px rgba(0,0,0,0.2)}
        .stats-total{background:#6c757d}
        .stats-valid{background:#28a745}
        .stats-invalid{background:#dc3545}
        .stats-waiting{background:#ffc107;color:#212529}
        .stats-all{background:#007bff}
        .selection-buttons{display:flex;gap:10px;margin:10px 0;justify-content:center;flex-wrap:wrap}
        .selection-btn{padding:8px 15px;font-size:0.85rem;border:none;cursor:pointer;border-radius:4px;transition:all 0.2s}
        .select-valid-btn{background:#28a745;color:white}
        .select-valid-btn:hover{background:#218838}
        .deselect-all-btn{background:#dc3545;color:white}
        .deselect-all-btn:hover{background:#c82333}
        .export-btn{background:#17a2b8;color:white}
        .export-btn:hover{background:#138496}
        .export-hd-btn{background:#ff6b35;color:white}
        .export-hd-btn:hover{background:#e55a2b}
        .export-selected-btn{background:#9c27b0;color:white}
        .export-selected-btn:hover{background:#7b1fa2}
        button{background:#4CAF50;color:white;border:none;padding:10px 15px;cursor:pointer;border-radius:4px;font-size:0.9rem;transition:background 0.2s}
        button:hover{background:#45a049}
        button:disabled{background:#ccc;cursor:not-allowed}
        .buttons{display:flex;gap:10px;justify-content:center;margin:15px 0;flex-wrap:wrap}
        .group-btn{background:#007bff}
        .group-btn:hover{background:#0069d9}
        .clear-btn{background:#6c757d}
        .clear-btn:hover{background:#5a6268}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000}
        .modal-content{background:white;padding:20px;border-radius:8px;max-width:95%;width:800px;max-height:90vh;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:1.2rem;font-weight:bold}
        .close-btn{font-size:24px;cursor:pointer;padding:0 10px}
        .group-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
        .group-item{padding:10px;background:#f8f9fa;border-radius:4px;text-align:left;position:relative;cursor:pointer;transition:all 0.2s}
        .group-item:hover{transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .group-item.selected{background:#e3f2fd;border:1px solid #2196F3}
        .group-name{font-weight:bold;margin-bottom:5px;display:flex;align-items:center}
        .group-count{font-size:0.8rem;color:#666}
        .show{display:flex}
        .result-area{flex:1;overflow-y:auto;margin-top:10px;border:1px solid #ddd;border-radius:4px;padding:10px}
        .group-checkbox{margin-right:8px;width:16px;height:16px;cursor:pointer}
        .group-select-actions{display:flex;gap:10px;margin-bottom:15px}
        .group-select-btn{padding:8px 15px;font-size:0.85rem}
        .select-all-btn{background:#28a745}
        .select-all-btn:hover{background:#218838}
        .deselect-all-group-btn{background:#dc3545}
        .deselect-all-group-btn:hover{background:#c82333}
        .settings{padding:15px;margin-bottom:15px;background:#f8f9fa;border-radius:6px;display:flex;flex-direction:column;gap:15px}
        .setting-item{display:flex;align-items:center;gap:10px}
        .setting-label{font-weight:bold;min-width:120px}
        .slider-container{display:flex;align-items:center;gap:10px;flex:1}
        .slider{flex:1;height:6px;-webkit-appearance:none;appearance:none;background:#ddd;border-radius:3px;outline:none}
        .slider::-webkit-slider-thumb{width:20px;height:20px;border-radius:50%;cursor:pointer;-webkit-appearance:none}
        .slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;cursor:pointer;border:none}
        .slider-value{font-weight:bold;min-width:40px;text-align:center}
        .timeout-slider::-webkit-slider-thumb{background:#4CAF50}
        .timeout-slider::-moz-range-thumb{background:#4CAF50}
        .timeout-value{color:#4CAF50}
        .concurrent-slider::-webkit-slider-thumb{background:#2196F3}
        .concurrent-slider::-moz-range-thumb{background:#2196F3}
        .concurrent-value{color:#2196F3}
        .settings-row{display:flex;gap:20px}
        .settings-column{flex:1;display:flex;flex-direction:column;gap:15px}
        .performance-warning{font-size:0.8rem;color:#dc3545;text-align:center;padding:5px;background:#f8d7da;border-radius:4px;margin-bottom:10px;display:none}
        .resolution-legend{margin-top:10px;display:flex;flex-wrap:wrap;gap:5px;justify-content:center}
        .legend-item{display:flex;align-items:center;gap:3px;font-size:0.7rem;padding:2px 5px;border-radius:3px}
        .filter-info{margin-top:5px;font-size:0.8rem;color:#666;text-align:center}
        .selected-count{margin-left:10px;font-weight:bold;color:#28a745}
        
        @media (max-width:768px){
            .container{padding:10px;margin:0;border-radius:0}
            .modal-content{padding:15px;max-width:98%}
            .group-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
            .buttons{flex-direction:column;align-items:stretch}
            button{width:100%}
            .selection-buttons{flex-direction:column;align-items:stretch}
            .selection-btn{width:100%}
            .channel{flex-wrap:wrap}
            .channel-name{flex-basis:100%;margin-bottom:5px}
            .channel-url{flex-basis:100%;margin-left:0;margin-bottom:5px;max-width:100%}
            .status,.time{margin-left:0;margin-right:10px}
            .settings{flex-direction:column;gap:10px}
            .setting-item{flex-direction:column;align-items:flex-start;gap:5px}
            .setting-label{min-width:auto}
            .slider-container{width:100%}
            .settings-row{flex-direction:column;gap:15px}
            .resolution-legend{justify-content:flex-start;gap:3px}
            .stats-btn{font-size:0.8rem;padding:2px 5px;margin:0 1px}
            .network-input-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .network-input {
                width: 100%;
            }
            
            .play-btn {
                margin-right: 5px;
                min-width: 50px;
                padding: 3px 6px;
                font-size: 0.7rem;
            }
            
            .video-preview-container {
                min-height: 250px;
            }
            
            .video-preview-header {
                padding: 10px 15px;
            }
            
            #previewVideo {
                max-height: calc(60vh - 50px);
            }
        }
        @media (max-width:480px){
            h1{font-size:1.2rem}
            .upload-area{padding:15px}
            .group-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
            .channel-url{font-size:0.75rem}
            .resolution-badge{font-size:0.6rem;padding:0 4px;min-width:35px}
            .play-btn {
                min-width: 45px;
                padding: 2px 4px;
                font-size: 0.65rem;
            }
            
            .video-preview-container {
                min-height: 200px;
            }
            
            .video-preview-header {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .video-preview-title {
                font-size: 0.95rem;
            }
            
            .close-preview-btn {
                padding: 4px 10px;
                font-size: 0.8rem;
            }
            
            #previewVideo {
                max-height: calc(50vh - 45px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>直播源检测工具</h1>
        
        <div class="video-preview-container" id="videoPreviewContainer">
            <div class="video-preview-header">
                <div class="video-preview-title" id="previewTitle">视频预览</div>
                <button class="close-preview-btn" id="closePreviewBtn">关闭预览</button>
            </div>
            <video id="previewVideo" controls preload="auto">
                您的浏览器不支持 video 标签。
            </video>
        </div>
        
        <div class="network-import">
            <div class="network-input-row">
                <input type="url" class="network-input" id="directUrlInput" 
                       placeholder="输入直播源URL (支持m3u/txt格式，需同源或无CORS限制)">
                <button class="network-btn" id="directImportBtn">网络导入</button>
            </div>
            <div class="network-status" id="directStatus">
                <small>提示：仅支持同源或无CORS限制的URL。如果导入失败，请下载文件后使用本地导入。</small>
            </div>
            <div class="network-loading" id="networkLoading">
                <div class="loading-spinner"></div>
                <span>正在加载...</span>
            </div>
        </div>
        
        <div class="upload-area" id="dropArea">
            点击或拖拽m3u/txt文件到此处
            <input type="file" id="fileInput" class="file-input" accept=".m3u,.txt">
        </div>
        
        <div class="performance-warning" id="performanceWarning">
            注意：高并发检测可能导致浏览器内存占用过高，建议并发数不超过5个
        </div>
        
        <div class="settings">
            <div class="settings-row">
                <div class="settings-column">
                    <div class="setting-item">
                        <div class="setting-label">检测超时时间:</div>
                        <div class="slider-container">
                            <input type="range" id="timeoutSlider" class="slider timeout-slider" min="1" max="20" value="10" step="1">
                            <div class="slider-value timeout-value" id="timeoutValue">10秒</div>
                        </div>
                    </div>
                </div>
                <div class="settings-column">
                    <div class="setting-item">
                        <div class="setting-label">并发检测数量:</div>
                        <div class="slider-container">
                            <input type="range" id="concurrentSlider" class="slider concurrent-slider" min="1" max="20" value="3" step="1">
                            <div class="slider-value concurrent-value" id="concurrentValue">3个</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="resolution-legend" id="resolutionLegend">
            <div class="legend-item resolution-4k">4K</div>
            <div class="legend-item resolution-2k">2K</div>
            <div class="legend-item resolution-1080p">1080p</div>
            <div class="legend-item resolution-720p">720p</div>
            <div class="legend-item resolution-480p">480p</div>
            <div class="legend-item resolution-360p">360p</div>
            <div class="legend-item resolution-240p">240p</div>
            <div class="legend-item resolution-sd">SD</div>
            <div class="legend-item resolution-unknown">未知</div>
        </div>
        
        <div class="buttons">
            <button id="checkBtn" disabled>开始检测</button>
            <button id="groupBtn" class="group-btn" disabled>分组显示</button>
            <button id="clearBtn" class="clear-btn">清除</button>
        </div>
        
        <div class="stats" id="stats"></div>
        <div class="filter-info" id="filterInfo"></div>
        
        <div class="selection-buttons">
            <button id="selectValidBtn" class="selection-btn select-valid-btn">有效全部勾选</button>
            <button id="deselectAllBtn" class="selection-btn deselect-all-btn">全部取消勾选</button>
            <button id="exportSelectedBtn" class="selection-btn export-selected-btn">导出勾选</button>
            <button id="exportHDChannelsBtn" class="selection-btn export-hd-btn">导出高清频道</button>
            <button id="exportAllValidBtn" class="selection-btn export-btn">导出全部有效</button>
            <span class="selected-count" id="selectedCount">已选中: 0</span>
        </div>
        
        <div class="result-area" id="resultArea"></div>
    </div>

    <div class="modal" id="groupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">分组信息 (已选择 <span id="selectedGroupsCount">0</span>/<span id="totalGroupsCount">0</span>)</div>
                <div class="close-btn" id="closeModal">×</div>
            </div>
            <div class="group-select-actions">
                <button id="selectAllGroupsBtn" class="group-select-btn select-all-btn">全选</button>
                <button id="deselectAllGroupsBtn" class="group-select-btn deselect-all-group-btn">全不选</button>
            </div>
            <div id="groupList" class="group-grid"></div>
        </div>
    </div>

    <script>
        // ==================== 配置和常量 ====================
        const CONFIG = {
            DEFAULT_TIMEOUT: 10,
            DEFAULT_CONCURRENT: 3,
            MAX_CONCURRENT_WARNING: 5,
            RESOLUTION_STANDARDS: [
                { minWidth: 3840, minHeight: 2160, description: '4K', className: 'resolution-4k' },
                { minWidth: 2560, minHeight: 1440, description: '2K', className: 'resolution-2k' },
                { minWidth: 1920, minHeight: 1080, description: '1080p', className: 'resolution-1080p' },
                { minWidth: 1280, minHeight: 720, description: '720p', className: 'resolution-720p' },
                { minWidth: 854, minHeight: 480, description: '480p', className: 'resolution-480p' },
                { minWidth: 640, minHeight: 360, description: '360p', className: 'resolution-360p' },
                { minWidth: 426, minHeight: 240, description: '240p', className: 'resolution-240p' }
            ]
        };
        
        // ==================== 状态管理 ====================
        const AppState = {
            channels: [],
            groups: {},
            displayedChannels: [],
            selectedGroups: new Set(),
            selectedChannels: new Set(),
            channelResolutions: new Map(),
            activeVideoElements: new Map(),
            videoElementCounter: 0,
            currentFilter: 'all',
            currentPlayingChannelIndex: -1,
            isChecking: false,
            timeoutSeconds: CONFIG.DEFAULT_TIMEOUT,
            concurrentLimit: CONFIG.DEFAULT_CONCURRENT
        };
        
        // ==================== DOM元素缓存 ====================
        const DomElements = {
            // 基本元素
            fileInput: document.getElementById('fileInput'),
            dropArea: document.getElementById('dropArea'),
            checkBtn: document.getElementById('checkBtn'),
            groupBtn: document.getElementById('groupBtn'),
            clearBtn: document.getElementById('clearBtn'),
            resultArea: document.getElementById('resultArea'),
            statsDiv: document.getElementById('stats'),
            filterInfo: document.getElementById('filterInfo'),
            
            // 模态框相关
            groupModal: document.getElementById('groupModal'),
            groupList: document.getElementById('groupList'),
            closeModal: document.getElementById('closeModal'),
            selectAllGroupsBtn: document.getElementById('selectAllGroupsBtn'),
            deselectAllGroupsBtn: document.getElementById('deselectAllGroupsBtn'),
            selectedGroupsCount: document.getElementById('selectedGroupsCount'),
            totalGroupsCount: document.getElementById('totalGroupsCount'),
            
            // 设置相关
            timeoutSlider: document.getElementById('timeoutSlider'),
            timeoutValue: document.getElementById('timeoutValue'),
            concurrentSlider: document.getElementById('concurrentSlider'),
            concurrentValue: document.getElementById('concurrentValue'),
            performanceWarning: document.getElementById('performanceWarning'),
            resolutionLegend: document.getElementById('resolutionLegend'),
            
            // 批量操作相关
            selectValidBtn: document.getElementById('selectValidBtn'),
            deselectAllBtn: document.getElementById('deselectAllBtn'),
            exportSelectedBtn: document.getElementById('exportSelectedBtn'),
            exportHDChannelsBtn: document.getElementById('exportHDChannelsBtn'),
            exportAllValidBtn: document.getElementById('exportAllValidBtn'),
            selectedCount: document.getElementById('selectedCount'),
            
            // 网络导入相关
            directUrlInput: document.getElementById('directUrlInput'),
            directImportBtn: document.getElementById('directImportBtn'),
            directStatus: document.getElementById('directStatus'),
            networkLoading: document.getElementById('networkLoading'),
            
            // 视频预览相关
            videoPreviewContainer: document.getElementById('videoPreviewContainer'),
            previewVideo: document.getElementById('previewVideo'),
            previewTitle: document.getElementById('previewTitle'),
            closePreviewBtn: document.getElementById('closePreviewBtn')
        };
        
        // ==================== 工具函数 ====================
        const Utils = {
            msToSeconds(ms) {
                return (ms / 1000).toFixed(2);
            },
            
            getResolutionInfo(width, height) {
                if (!width || !height) {
                    return { description: '未知分辨率', className: 'resolution-unknown' };
                }
                
                for (const res of CONFIG.RESOLUTION_STANDARDS) {
                    if (width >= res.minWidth && height >= res.minHeight) {
                        return { description: res.description, className: res.className };
                    }
                }
                
                if (width >= 640 && height >= 480) {
                    return { description: 'SD', className: 'resolution-sd' };
                }
                
                return { description: `${width}×${height}`, className: 'resolution-unknown' };
            },
            
            isHDChannel(channel, channelIndex) {
                const resolutionInfo = AppState.channelResolutions.get(channelIndex);
                if (resolutionInfo?.width && resolutionInfo?.height) {
                    return resolutionInfo.width >= 1920 && resolutionInfo.height >= 1080;
                }
                
                if (channel.resolution) {
                    const hdResolutions = ['1080p', '2K', '4K'];
                    return hdResolutions.some(res => channel.resolution.includes(res));
                }
                
                return false;
            },
            
            async fetchWithTimeout(url, options = {}, timeout = AppState.timeoutSeconds * 1000) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            },
            
            createBlobUrl(content, type) {
                const blob = new Blob([content], { type });
                return URL.createObjectURL(blob);
            },
            
            downloadFile(blobUrl, filename) {
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
            }
        };
        
        // ==================== 视频管理 ====================
        const VideoManager = {
            createVideoElement() {
                const videoId = `video_${Date.now()}_${AppState.videoElementCounter++}`;
                const video = document.createElement('video');
                
                video.setAttribute('preload', 'auto');
                video.setAttribute('playsinline', '');
                video.setAttribute('webkit-playsinline', '');
                video.muted = true;
                video.volume = 0;
                video.style.cssText = 'display:none;position:absolute;top:-9999px;left:-9999px;width:1px;height:1px';
                
                AppState.activeVideoElements.set(videoId, { video, cleanupTimeout: null });
                document.body.appendChild(video);
                
                return { videoId, video };
            },
            
            forceCleanupVideoElement(videoId) {
                if (!AppState.activeVideoElements.has(videoId)) return;
                
                const videoInfo = AppState.activeVideoElements.get(videoId);
                if (!videoInfo?.video) return;
                
                const video = videoInfo.video;
                
                try {
                    // 清除事件监听器
                    video.onloadeddata = null;
                    video.oncanplay = null;
                    video.onerror = null;
                    video.onstalled = null;
                    video.onsuspend = null;
                    video.onabort = null;
                    
                    // 停止播放
                    video.pause();
                    video.currentTime = 0;
                    video.src = '';
                    
                    // 清理媒体源
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    }
                    
                    // 移除元素
                    if (video.parentNode) {
                        video.parentNode.removeChild(video);
                    }
                    
                    video.load();
                    
                } catch (error) {
                    console.warn('清理视频元素时出错:', error);
                } finally {
                    AppState.activeVideoElements.delete(videoId);
                }
            },
            
            cleanupAllVideoElements() {
                const videoIds = Array.from(AppState.activeVideoElements.keys());
                videoIds.forEach(videoId => this.forceCleanupVideoElement(videoId));
                AppState.activeVideoElements.clear();
            },
            
            async safeVideoCleanup(videoId, delay = 100) {
                return new Promise(resolve => {
                    if (AppState.activeVideoElements.has(videoId)) {
                        const videoInfo = AppState.activeVideoElements.get(videoId);
                        
                        if (videoInfo.cleanupTimeout) {
                            clearTimeout(videoInfo.cleanupTimeout);
                        }
                        
                        videoInfo.cleanupTimeout = setTimeout(() => {
                            this.forceCleanupVideoElement(videoId);
                            setTimeout(resolve, 50);
                        }, delay);
                    } else {
                        resolve();
                    }
                });
            }
        };
        
        // ==================== 文件解析 ====================
        const FileParser = {
            parseM3UFormat(lines) {
                let currentName = '', currentGroup = '未分组';
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('#EXTINF')) {
                        const nameMatch = line.match(/,(.*)/);
                        if (nameMatch) currentName = nameMatch[1];
                        const groupMatch = line.match(/group-title="([^"]+)"/);
                        if (groupMatch) currentGroup = groupMatch[1];
                    } else if (line.startsWith('http')) {
                        this.addChannel(currentName || '未命名频道', line, currentGroup);
                        currentName = '';
                        currentGroup = '未分组';
                    }
                }
            },
            
            parseTXTFormat(lines) {
                let currentGroup = '未分组';
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    
                    if (line.includes(',#genre#')) {
                        const firstCommaIndex = line.indexOf(',');
                        if (firstCommaIndex !== -1) {
                            const groupName = line.substring(0, firstCommaIndex).trim();
                            if (groupName) {
                                currentGroup = groupName;
                                if (!AppState.groups[currentGroup]) {
                                    AppState.groups[currentGroup] = [];
                                }
                            }
                        }
                        continue;
                    }
                    
                    if (line.includes(',') && line.includes('http')) {
                        const firstCommaIndex = line.indexOf(',');
                        const channelName = line.substring(0, firstCommaIndex).trim();
                        const channelUrl = line.substring(firstCommaIndex + 1).trim();
                        if (channelUrl.startsWith('http')) {
                            this.addChannel(channelName || '未命名频道', channelUrl, currentGroup);
                        }
                    } else if (line.startsWith('http')) {
                        this.addChannel('未命名频道', line, currentGroup);
                    }
                }
                
                if (Object.keys(AppState.groups).length === 0 && AppState.channels.length > 0) {
                    AppState.groups['未分组'] = [...AppState.channels];
                    AppState.channels.forEach(channel => channel.group = '未分组');
                }
            },
            
            addChannel(name, url, group) {
                const channel = { 
                    name, 
                    url, 
                    group, 
                    valid: null, 
                    time: null, 
                    resolution: null,
                    resolutionClass: null 
                };
                
                AppState.channels.push(channel);
                
                if (!AppState.groups[group]) {
                    AppState.groups[group] = [];
                }
                AppState.groups[group].push(channel);
            },
            
            parseFile(content) {
                AppState.channels = [];
                AppState.groups = {};
                AppState.selectedGroups.clear();
                AppState.displayedChannels = [];
                AppState.selectedChannels.clear();
                AppState.channelResolutions.clear();
                AppState.currentPlayingChannelIndex = -1;
                
                DomElements.videoPreviewContainer.classList.remove('active');
                UI.updateSelectedCount();
                
                const lines = content.split('\n');
                const isM3UFormat = lines.some(line => line.includes('#EXTINF'));
                
                if (isM3UFormat) {
                    this.parseM3UFormat(lines);
                } else {
                    this.parseTXTFormat(lines);
                }
                
                Object.keys(AppState.groups).forEach(group => AppState.selectedGroups.add(group));
            }
        };
        
        // ==================== 用户界面管理 ====================
        const UI = {
            updateTimeoutDisplay() {
                DomElements.timeoutValue.textContent = `${AppState.timeoutSeconds}秒`;
            },
            
            updateConcurrentDisplay() {
                DomElements.concurrentValue.textContent = `${AppState.concurrentLimit}个`;
                DomElements.performanceWarning.style.display = 
                    AppState.concurrentLimit > CONFIG.MAX_CONCURRENT_WARNING ? 'block' : 'none';
            },
            
            updateSelectedCount() {
                DomElements.selectedCount.textContent = `已选中: ${AppState.selectedChannels.size}`;
            },
            
            showLoading(show) {
                DomElements.networkLoading.style.display = show ? 'flex' : 'none';
                DomElements.directImportBtn.disabled = show;
            },
            
            setStatus(message, isError = false) {
                DomElements.directStatus.textContent = message;
                DomElements.directStatus.style.color = isError ? '#dc3545' : '#28a745';
            },
            
            updateResolutionDisplay(displayIndex, resolution, className) {
                const resolutionElement = document.getElementById(`resolution-${displayIndex}`);
                if (resolutionElement) {
                    resolutionElement.textContent = resolution;
                    resolutionElement.className = `resolution-badge ${className}`;
                    resolutionElement.style.display = resolution ? 'inline' : 'none';
                }
            },
            
            updatePlayButtonStates(activeIndex) {
                AppState.displayedChannels.forEach((item, index) => {
                    const playBtn = document.getElementById(`play-btn-${index}`);
                    if (playBtn) {
                        if (index === activeIndex) {
                            playBtn.classList.add('playing');
                            playBtn.innerHTML = '<i>⏸</i>停止';
                        } else {
                            playBtn.classList.remove('playing');
                            playBtn.innerHTML = '<i>▶</i>播放';
                        }
                    }
                });
            },
            
            updateStats() {
                const channelsInSelectedGroups = AppState.channels.filter(
                    channel => AppState.selectedGroups.has(channel.group)
                );
                
                const total = channelsInSelectedGroups.length;
                const valid = channelsInSelectedGroups.filter(c => c.valid === true).length;
                const invalid = channelsInSelectedGroups.filter(c => c.valid === false).length;
                const waiting = channelsInSelectedGroups.filter(c => c.valid === null).length;
                const filteredCount = this.getFilteredChannels().length;
                
                const hdChannels = channelsInSelectedGroups.filter(channel => 
                    channel.valid === true && 
                    Utils.isHDChannel(channel, AppState.channels.indexOf(channel))
                ).length;
                
                const statsHTML = `
                    <span>筛选: </span>
                    <button class="stats-btn stats-all ${AppState.currentFilter === 'all' ? 'active' : ''}" data-filter="all">
                        全部 (${total})
                    </button>
                    <button class="stats-btn stats-valid ${AppState.currentFilter === 'valid' ? 'active' : ''}" data-filter="valid">
                        有效 (${valid})
                    </button>
                    <button class="stats-btn stats-invalid ${AppState.currentFilter === 'invalid' ? 'active' : ''}" data-filter="invalid">
                        无效 (${invalid})
                    </button>
                    <button class="stats-btn stats-waiting ${AppState.currentFilter === 'waiting' ? 'active' : ''}" data-filter="waiting">
                        等待 (${waiting})
                    </button>
                    <span> | 高清: ${hdChannels} | 超时: ${AppState.timeoutSeconds}秒 | 并发: ${AppState.concurrentLimit}个 | 显示: ${filteredCount}/${total}</span>
                `;
                
                DomElements.statsDiv.innerHTML = statsHTML;
                
                DomElements.statsDiv.querySelectorAll('.stats-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const filter = e.target.getAttribute('data-filter');
                        this.applyFilter(filter);
                    });
                });
                
                if (waiting === 0 && total > 0) {
                    DomElements.checkBtn.textContent = '重新检测';
                }
            },
            
            updateFilterInfo() {
                const filterTexts = {
                    'all': '显示全部频道',
                    'valid': '只显示有效频道',
                    'invalid': '只显示无效频道',
                    'waiting': '只显示等待检测频道'
                };
                
                DomElements.filterInfo.textContent = filterTexts[AppState.currentFilter] || '';
            },
            
            getFilteredChannels() {
                const channelsInSelectedGroups = AppState.channels.filter(
                    channel => AppState.selectedGroups.has(channel.group)
                );
                
                switch(AppState.currentFilter) {
                    case 'valid':
                        return channelsInSelectedGroups.filter(c => c.valid === true);
                    case 'invalid':
                        return channelsInSelectedGroups.filter(c => c.valid === false);
                    case 'waiting':
                        return channelsInSelectedGroups.filter(c => c.valid === null);
                    case 'all':
                    default:
                        return channelsInSelectedGroups;
                }
            },
            
            applyFilter(filter) {
                AppState.currentFilter = filter;
                this.displayChannels();
                this.updateFilterInfo();
            },
            
            displayChannels() {
                DomElements.resultArea.innerHTML = '';
                AppState.displayedChannels = [];
                
                const channelsToDisplay = this.getFilteredChannels();
                
                channelsToDisplay.forEach((channel, index) => {
                    const channelDiv = document.createElement('div');
                    channelDiv.className = 'channel';
                    channelDiv.id = `channel-display-${index}`;
                    
                    const resolutionBadge = channel.resolution ? 
                        `<span class="resolution-badge ${channel.resolutionClass || 'resolution-unknown'}" id="resolution-${index}">${channel.resolution}</span>` :
                        `<span class="resolution-badge" id="resolution-${index}" style="display:none"></span>`;
                    
                    let statusText = '等待检测';
                    let statusClass = 'waiting';
                    if (channel.valid === true) {
                        statusText = '有效';
                        statusClass = 'valid';
                    } else if (channel.valid === false) {
                        statusText = '无效';
                        statusClass = 'invalid';
                    }
                    
                    const checkboxDisabled = channel.valid !== true ? 'disabled' : '';
                    const isChecked = AppState.selectedChannels.has(channel) ? 'checked' : '';
                    const isPlaying = AppState.currentPlayingChannelIndex === index;
                    const playBtnText = isPlaying ? '<i>⏸</i>停止' : '<i>▶</i>播放';
                    const playBtnClass = isPlaying ? 'play-btn playing' : 'play-btn';
                    
                    channelDiv.innerHTML = `
                        <div class="channel-name">
                            <input type="checkbox" id="channel-checkbox-${index}" class="channel-checkbox" 
                                   ${checkboxDisabled} ${isChecked} data-channel-index="${index}">
                            <button class="${playBtnClass}" id="play-btn-${index}" data-channel-index="${index}">
                                ${playBtnText}
                            </button>
                            ${channel.name}
                            ${resolutionBadge}
                        </div>
                        <div class="channel-url" title="${channel.url}">${channel.url}</div>
                        <div class="status ${statusClass}">${statusText}</div>
                        <div class="time">${channel.time ? `${Utils.msToSeconds(channel.time)}s` : '-'}</div>
                    `;
                    
                    DomElements.resultArea.appendChild(channelDiv);
                    AppState.displayedChannels.push({ 
                        channel, 
                        displayIndex: index, 
                        originalIndex: AppState.channels.indexOf(channel) 
                    });
                });
                
                this.attachChannelEventListeners();
                this.updateStats();
            },
            
            attachChannelEventListeners() {
                AppState.displayedChannels.forEach((item, index) => {
                    const checkbox = document.getElementById(`channel-checkbox-${index}`);
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                AppState.selectedChannels.add(item.channel);
                            } else {
                                AppState.selectedChannels.delete(item.channel);
                            }
                            this.updateSelectedCount();
                        });
                    }
                    
                    const playBtn = document.getElementById(`play-btn-${index}`);
                    if (playBtn) {
                        playBtn.addEventListener('click', () => {
                            VideoPlayer.handlePlayButtonClick(item.channel, index);
                        });
                    }
                });
            },
            
            showGroupModal() {
                DomElements.groupList.innerHTML = '';
                DomElements.totalGroupsCount.textContent = Object.keys(AppState.groups).length;
                DomElements.selectedGroupsCount.textContent = AppState.selectedGroups.size;
                
                const fragment = document.createDocumentFragment();
                
                Object.keys(AppState.groups).sort().forEach(groupName => {
                    const groupItem = document.createElement('div');
                    groupItem.className = AppState.selectedGroups.has(groupName) ? 'group-item selected' : 'group-item';
                    groupItem.innerHTML = `
                        <div class="group-name">
                            <input type="checkbox" class="group-checkbox" 
                                   ${AppState.selectedGroups.has(groupName) ? 'checked' : ''} 
                                   data-group="${groupName}">
                            ${groupName}
                        </div>
                        <div class="group-count">${AppState.groups[groupName].length}个频道</div>
                    `;
                    fragment.appendChild(groupItem);
                });
                
                DomElements.groupList.appendChild(fragment);
                
                DomElements.groupList.querySelectorAll('.group-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const groupName = e.target.dataset.group;
                        if (e.target.checked) {
                            AppState.selectedGroups.add(groupName);
                        } else {
                            AppState.selectedGroups.delete(groupName);
                        }
                        e.target.closest('.group-item').classList.toggle('selected', e.target.checked);
                        DomElements.selectedGroupsCount.textContent = AppState.selectedGroups.size;
                        this.applyFilter(AppState.currentFilter);
                    });
                });
                
                DomElements.groupModal.classList.add('show');
            },
            
            updateCheckboxStates() {
                AppState.displayedChannels.forEach((item, index) => {
                    const checkbox = document.getElementById(`channel-checkbox-${index}`);
                    if (checkbox) {
                        checkbox.checked = AppState.selectedChannels.has(item.channel);
                    }
                });
            }
        };
        
        // ==================== 视频播放器 ====================
        const VideoPlayer = {
            playChannelVideo(channel, displayIndex) {
                this.stopCurrentVideo();
                
                AppState.currentPlayingChannelIndex = displayIndex;
                UI.updatePlayButtonStates(displayIndex);
                
                DomElements.videoPreviewContainer.classList.add('active');
                DomElements.previewTitle.textContent = `正在播放: ${channel.name}`;
                DomElements.previewVideo.src = channel.url;
                
                DomElements.previewVideo.play().catch(error => {
                    console.error('播放失败:', error);
                    DomElements.previewTitle.textContent = `播放失败: ${channel.name}`;
                    
                    const playBtn = document.getElementById(`play-btn-${displayIndex}`);
                    if (playBtn) {
                        playBtn.classList.remove('playing');
                        playBtn.innerHTML = '<i>▶</i>播放';
                    }
                    
                    AppState.currentPlayingChannelIndex = -1;
                });
                
                DomElements.previewVideo.onended = () => {
                    this.stopCurrentVideo();
                };
                
                DomElements.previewVideo.onerror = () => {
                    DomElements.previewTitle.textContent = `播放错误: ${channel.name}`;
                    const playBtn = document.getElementById(`play-btn-${displayIndex}`);
                    if (playBtn) {
                        playBtn.classList.remove('playing');
                        playBtn.innerHTML = '<i>▶</i>播放';
                    }
                    AppState.currentPlayingChannelIndex = -1;
                };
            },
            
            stopCurrentVideo() {
                if (AppState.currentPlayingChannelIndex !== -1) {
                    const playBtn = document.getElementById(`play-btn-${AppState.currentPlayingChannelIndex}`);
                    if (playBtn) {
                        playBtn.classList.remove('playing');
                        playBtn.innerHTML = '<i>▶</i>播放';
                    }
                }
                
                DomElements.previewVideo.pause();
                DomElements.previewVideo.src = '';
                DomElements.previewVideo.currentTime = 0;
                DomElements.videoPreviewContainer.classList.remove('active');
                AppState.currentPlayingChannelIndex = -1;
            },
            
            handlePlayButtonClick(channel, index) {
                if (AppState.currentPlayingChannelIndex === index) {
                    this.stopCurrentVideo();
                } else {
                    this.playChannelVideo(channel, index);
                }
            }
        };
        
        // ==================== 频道检测 ====================
        const ChannelChecker = {
            async checkChannel(channel, displayIndex) {
                const channelDiv = document.getElementById(`channel-display-${displayIndex}`);
                if (!channelDiv) return false;
                
                const statusEl = channelDiv.querySelector('.status');
                const timeEl = channelDiv.querySelector('.time');
                statusEl.className = 'status checking';
                statusEl.textContent = '检测中...';
                const startTime = Date.now();
                
                if (!channel.url.startsWith('http')) {
                    this.setChannelResult(channel, statusEl, timeEl, startTime, false, '无效协议');
                    return false;
                }
                
                return new Promise(async (resolve) => {
                    let videoId = null;
                    let timeoutId = null;
                    let hasResolved = false;
                    
                    const resolveWithCleanup = (result, resolutionInfo = null, width = null, height = null) => {
                        if (hasResolved) return;
                        hasResolved = true;
                        
                        if (resolutionInfo) {
                            channel.resolution = resolutionInfo.description;
                            channel.resolutionClass = resolutionInfo.className;
                            UI.updateResolutionDisplay(displayIndex, resolutionInfo.description, resolutionInfo.className);
                        }
                        
                        if (width && height) {
                            const channelIndex = AppState.channels.indexOf(channel);
                            AppState.channelResolutions.set(channelIndex, { width, height });
                        }
                        
                        if (timeoutId) clearTimeout(timeoutId);
                        
                        if (videoId) {
                            VideoManager.safeVideoCleanup(videoId, 100).then(() => {
                                setTimeout(() => resolve(result), 50);
                            });
                        } else {
                            resolve(result);
                        }
                    };
                    
                    try {
                        const videoInfo = VideoManager.createVideoElement();
                        videoId = videoInfo.videoId;
                        const videoElement = videoInfo.video;
                        
                        const timeoutMs = AppState.timeoutSeconds * 1000;
                        timeoutId = setTimeout(() => {
                            this.setChannelResult(channel, statusEl, timeEl, startTime, false, `超时(${AppState.timeoutSeconds}s)`);
                            resolveWithCleanup(false);
                        }, timeoutMs);
                        
                        let loadeddataTriggered = false;
                        let canplayTriggered = false;
                        
                        const checkResolution = () => {
                            try {
                                if (videoElement?.videoWidth && videoElement?.videoHeight) {
                                    return {
                                        resolutionInfo: Utils.getResolutionInfo(videoElement.videoWidth, videoElement.videoHeight),
                                        width: videoElement.videoWidth,
                                        height: videoElement.videoHeight
                                    };
                                }
                            } catch (e) {
                                console.warn('获取分辨率失败:', e);
                            }
                            return null;
                        };
                        
                        const onLoadedData = () => {
                            loadeddataTriggered = true;
                            checkBothEvents();
                        };
                        
                        const onCanPlay = () => {
                            canplayTriggered = true;
                            checkBothEvents();
                        };
                        
                        const checkBothEvents = () => {
                            if (loadeddataTriggered && canplayTriggered && !hasResolved) {
                                const resolutionData = checkResolution();
                                this.setChannelResult(channel, statusEl, timeEl, startTime, true, '有效');
                                
                                if (resolutionData) {
                                    resolveWithCleanup(true, resolutionData.resolutionInfo, resolutionData.width, resolutionData.height);
                                } else {
                                    resolveWithCleanup(true);
                                }
                            }
                        };
                        
                        const onError = () => {
                            if (!hasResolved) {
                                this.setChannelResult(channel, statusEl, timeEl, startTime, false, '无法播放');
                                resolveWithCleanup(false);
                            }
                        };
                        
                        videoElement.addEventListener('loadeddata', onLoadedData, { once: true });
                        videoElement.addEventListener('canplay', onCanPlay, { once: true });
                        videoElement.addEventListener('error', onError, { once: true });
                        
                        videoElement.addEventListener('loadedmetadata', () => {
                            if (!hasResolved && videoElement) {
                                if (loadeddataTriggered && canplayTriggered) {
                                    const resolutionData = checkResolution();
                                    if (resolutionData && channel.valid === true) {
                                        channel.resolution = resolutionData.resolutionInfo.description;
                                        channel.resolutionClass = resolutionData.resolutionInfo.className;
                                        UI.updateResolutionDisplay(displayIndex, resolutionData.resolutionInfo.description, resolutionData.resolutionInfo.className);
                                        
                                        const channelIndex = AppState.channels.indexOf(channel);
                                        AppState.channelResolutions.set(channelIndex, { 
                                            width: resolutionData.width, 
                                            height: resolutionData.height 
                                        });
                                    }
                                }
                            }
                        }, { once: true });
                        
                        videoElement.src = channel.url;
                        videoElement.load();
                        
                    } catch (error) {
                        console.error('检测过程中发生错误:', error);
                        this.setChannelResult(channel, statusEl, timeEl, startTime, false, '检测失败');
                        resolveWithCleanup(false);
                    }
                });
            },
            
            setChannelResult(channel, statusEl, timeEl, startTime, isValid, statusText) {
                channel.valid = isValid;
                channel.time = Date.now() - startTime;
                statusEl.className = `status ${isValid ? 'valid' : 'invalid'}`;
                statusEl.textContent = statusText;
                timeEl.textContent = `${Utils.msToSeconds(channel.time)}s`;
                UI.updateStats();
            },
            
            async checkChannelsSafely() {
                const executing = new Set();
                const results = [];
                
                for (let i = 0; i < AppState.displayedChannels.length; i++) {
                    const item = AppState.displayedChannels[i];
                    
                    if (AppState.activeVideoElements.size >= AppState.concurrentLimit) {
                        await Promise.race(executing);
                    }
                    
                    const promise = this.checkChannel(item.channel, item.displayIndex)
                        .finally(() => {
                            executing.delete(promise);
                        });
                    
                    executing.add(promise);
                    results.push(promise);
                    
                    if (executing.size >= AppState.concurrentLimit) {
                        await Promise.race(executing);
                    }
                }
                
                await Promise.all(results);
                VideoManager.cleanupAllVideoElements();
            },
            
            async startChecking() {
                if (AppState.isChecking || AppState.displayedChannels.length === 0) {
                    console.log('无法开始检测:', { 
                        isChecking: AppState.isChecking, 
                        displayedChannelsLength: AppState.displayedChannels.length 
                    });
                    return;
                }
                
                AppState.isChecking = true;
                DomElements.checkBtn.disabled = true;
                DomElements.checkBtn.textContent = '检测中...';
                
                DomElements.timeoutSlider.disabled = true;
                DomElements.concurrentSlider.disabled = true;
                DomElements.groupBtn.disabled = true;
                
                VideoPlayer.stopCurrentVideo();
                
                AppState.channels.forEach(channel => {
                    if (AppState.selectedGroups.has(channel.group)) { 
                        channel.valid = null; 
                        channel.time = null; 
                        channel.resolution = null;
                        channel.resolutionClass = null;
                    }
                });
                
                AppState.channelResolutions.clear();
                AppState.selectedChannels.clear();
                UI.updateSelectedCount();
                UI.applyFilter('all');
                
                try {
                    await this.checkChannelsSafely();
                    console.log('检测完成');
                } catch (error) {
                    console.error('检测过程中发生错误:', error);
                } finally {
                    VideoManager.cleanupAllVideoElements();
                    
                    AppState.isChecking = false;
                    DomElements.checkBtn.disabled = false;
                    DomElements.checkBtn.textContent = '重新检测';
                    DomElements.timeoutSlider.disabled = false;
                    DomElements.concurrentSlider.disabled = false;
                    DomElements.groupBtn.disabled = false;
                    
                    UI.updateStats();
                }
            }
        };
        
        // ==================== 导出功能 ====================
        const Exporter = {
            exportSelectedChannels() {
                const selectedChannelsList = Array.from(AppState.selectedChannels);
                
                if (selectedChannelsList.length === 0) {
                    alert('没有勾选的频道可以导出');
                    return;
                }
                
                const { m3uContent, txtContent } = this.generateExportContent(selectedChannelsList);
                const timestamp = new Date().getTime();
                
                const m3uBlobUrl = Utils.createBlobUrl(m3uContent, 'application/vnd.apple.mpegurl');
                const txtBlobUrl = Utils.createBlobUrl(txtContent, 'text/plain');
                
                Utils.downloadFile(m3uBlobUrl, `selected_channels_${timestamp}.m3u`);
                Utils.downloadFile(txtBlobUrl, `selected_channels_${timestamp}.txt`);
                
                alert(`已导出 ${selectedChannelsList.length} 个勾选频道`);
            },
            
            exportHDChannels() {
                const hdChannels = AppState.channels.filter(channel => 
                    AppState.selectedGroups.has(channel.group) && 
                    channel.valid === true && 
                    Utils.isHDChannel(channel, AppState.channels.indexOf(channel))
                );
                
                if (hdChannels.length === 0) {
                    alert('没有找到1080p及以上的高清频道');
                    return;
                }
                
                const { m3uContent, txtContent } = this.generateExportContent(hdChannels);
                const timestamp = new Date().getTime();
                
                const m3uBlobUrl = Utils.createBlobUrl(m3uContent, 'application/vnd.apple.mpegurl');
                const txtBlobUrl = Utils.createBlobUrl(txtContent, 'text/plain');
                
                Utils.downloadFile(m3uBlobUrl, `hd_channels_${timestamp}.m3u`);
                Utils.downloadFile(txtBlobUrl, `hd_channels_${timestamp}.txt`);
                
                alert(`已导出 ${hdChannels.length} 个高清频道（1080p及以上）`);
            },
            
            exportAllValidChannels() {
                const validChannels = AppState.channels.filter(channel => 
                    AppState.selectedGroups.has(channel.group) && channel.valid === true
                );
                
                if (validChannels.length === 0) {
                    alert('没有有效频道可以导出');
                    return;
                }
                
                const { m3uContent, txtContent } = this.generateExportContent(validChannels);
                const timestamp = new Date().getTime();
                
                const m3uBlobUrl = Utils.createBlobUrl(m3uContent, 'application/vnd.apple.mpegurl');
                const txtBlobUrl = Utils.createBlobUrl(txtContent, 'text/plain');
                
                Utils.downloadFile(m3uBlobUrl, `all_valid_channels_${timestamp}.m3u`);
                Utils.downloadFile(txtBlobUrl, `all_valid_channels_${timestamp}.txt`);
                
                alert(`已导出 ${validChannels.length} 个有效频道`);
            },
            
            generateExportContent(channelsList) {
                let m3uContent = '#EXTM3U\n';
                let txtContent = '';
                
                const groupedChannels = {};
                
                channelsList.forEach(channel => {
                    if (!groupedChannels[channel.group]) {
                        groupedChannels[channel.group] = [];
                    }
                    groupedChannels[channel.group].push(channel);
                });
                
                Object.keys(groupedChannels).forEach(group => {
                    groupedChannels[group].forEach(channel => {
                        const resolution = channel.resolution ? ` [${channel.resolution}]` : '';
                        m3uContent += `#EXTINF:-1 group-title="${group}",${channel.name}${resolution}\n`;
                        m3uContent += `${channel.url}\n`;
                    });
                });
                
                Object.keys(groupedChannels).forEach(group => {
                    txtContent += `${group},#genre#\n`;
                    groupedChannels[group].forEach(channel => {
                        const resolution = channel.resolution ? ` [${channel.resolution}]` : '';
                        txtContent += `${channel.name}${resolution},${channel.url}\n`;
                    });
                });
                
                return { m3uContent, txtContent };
            }
        };
        
        // ==================== 批量操作 ====================
        const BatchOperations = {
            selectAllValidChannels() {
                const filteredChannels = UI.getFilteredChannels();
                const validChannels = filteredChannels.filter(channel => channel.valid === true);
                
                validChannels.forEach(channel => {
                    AppState.selectedChannels.add(channel);
                });
                
                UI.updateCheckboxStates();
                UI.updateSelectedCount();
            },
            
            deselectAllChannels() {
                AppState.selectedChannels.clear();
                UI.updateCheckboxStates();
                UI.updateSelectedCount();
            }
        };
        
        // ==================== 事件处理器 ====================
        const EventHandlers = {
            init() {
                this.bindFileEvents();
                this.bindButtonEvents();
                this.bindSliderEvents();
                this.bindModalEvents();
                this.bindNetworkImportEvents();
                this.bindVideoEvents();
                this.bindWindowEvents();
            },
            
            bindFileEvents() {
                DomElements.dropArea.addEventListener('click', () => DomElements.fileInput.click());
                
                DomElements.dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    DomElements.dropArea.style.borderColor = '#4CAF50';
                });
                
                DomElements.dropArea.addEventListener('dragleave', () => {
                    DomElements.dropArea.style.borderColor = '#ccc';
                });
                
                DomElements.dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    DomElements.dropArea.style.borderColor = '#ccc';
                    if (e.dataTransfer.files.length) {
                        DomElements.fileInput.files = e.dataTransfer.files;
                        this.handleFile(e.dataTransfer.files[0]);
                    }
                });
                
                DomElements.fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length) {
                        this.handleFile(e.target.files[0]);
                    }
                });
            },
            
            bindButtonEvents() {
                DomElements.checkBtn.addEventListener('click', () => ChannelChecker.startChecking());
                DomElements.groupBtn.addEventListener('click', () => UI.showGroupModal());
                DomElements.clearBtn.addEventListener('click', () => this.handleClear());
                
                DomElements.selectValidBtn.addEventListener('click', () => BatchOperations.selectAllValidChannels());
                DomElements.deselectAllBtn.addEventListener('click', () => BatchOperations.deselectAllChannels());
                DomElements.exportSelectedBtn.addEventListener('click', () => Exporter.exportSelectedChannels());
                DomElements.exportHDChannelsBtn.addEventListener('click', () => Exporter.exportHDChannels());
                DomElements.exportAllValidBtn.addEventListener('click', () => Exporter.exportAllValidChannels());
            },
            
            bindSliderEvents() {
                DomElements.timeoutSlider.addEventListener('input', (e) => {
                    AppState.timeoutSeconds = parseInt(e.target.value);
                    UI.updateTimeoutDisplay();
                });
                
                DomElements.concurrentSlider.addEventListener('input', (e) => {
                    AppState.concurrentLimit = parseInt(e.target.value);
                    UI.updateConcurrentDisplay();
                });
            },
            
            bindModalEvents() {
                DomElements.closeModal.addEventListener('click', () => {
                    DomElements.groupModal.classList.remove('show');
                });
                
                DomElements.groupModal.addEventListener('click', (e) => {
                    if (e.target === DomElements.groupModal) {
                        DomElements.groupModal.classList.remove('show');
                    }
                });
                
                DomElements.selectAllGroupsBtn.addEventListener('click', () => {
                    Object.keys(AppState.groups).forEach(group => AppState.selectedGroups.add(group));
                    this.updateGroupCheckboxes(true);
                });
                
                DomElements.deselectAllGroupsBtn.addEventListener('click', () => {
                    AppState.selectedGroups.clear();
                    this.updateGroupCheckboxes(false);
                });
            },
            
            bindNetworkImportEvents() {
                DomElements.directImportBtn.addEventListener('click', () => this.handleNetworkImport());
            },
            
            bindVideoEvents() {
                DomElements.closePreviewBtn.addEventListener('click', () => VideoPlayer.stopCurrentVideo());
            },
            
            bindWindowEvents() {
                window.addEventListener('beforeunload', () => {
                    VideoManager.cleanupAllVideoElements();
                });
                
                setInterval(() => {
                    if (AppState.activeVideoElements.size > 0) {
                        UI.updateStats();
                    }
                }, 2000);
            },
            
            async handleNetworkImport() {
                const url = DomElements.directUrlInput.value.trim();
                if (!url) {
                    UI.setStatus('请输入URL地址', true);
                    return;
                }
                
                if (!url.startsWith('http')) {
                    UI.setStatus('请输入有效的HTTP/HTTPS URL', true);
                    return;
                }
                
                UI.showLoading(true);
                UI.setStatus('正在尝试获取直播源文件...');
                
                try {
                    const response = await Utils.fetchWithTimeout(url, {
                        method: 'GET',
                        mode: 'cors',
                        headers: { 'Accept': 'text/plain, application/vnd.apple.mpegurl, */*' },
                        cache: 'no-cache'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const content = await response.text();
                    this.processImportedContent(content, url);
                    
                } catch (error) {
                    this.handleNetworkImportError(error);
                } finally {
                    UI.showLoading(false);
                }
            },
            
            processImportedContent(content, url) {
                FileParser.parseFile(content);
                UI.applyFilter('all');
                DomElements.checkBtn.disabled = false;
                DomElements.groupBtn.disabled = false;
                UI.setStatus(`成功导入 ${AppState.channels.length} 个频道`);
                DomElements.dropArea.innerHTML = `已从网络加载: ${url}`;
            },
            
            handleNetworkImportError(error) {
                console.error('网络导入失败:', error);
                
                let errorMessage = '网络导入失败: ';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage += 'CORS策略阻止了请求。\n\n解决方案：\n1. 下载文件后使用本地导入（推荐）\n2. 如果文件在您控制的服务器上，请添加CORS头\n3. 联系网站管理员请求添加CORS头';
                } else {
                    errorMessage += error.message;
                }
                
                UI.setStatus(errorMessage, true);
            },
            
            handleFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    FileParser.parseFile(e.target.result);
                    UI.applyFilter('all');
                    DomElements.checkBtn.disabled = false;
                    DomElements.groupBtn.disabled = false;
                    DomElements.dropArea.innerHTML = `已加载: ${file.name} (${AppState.channels.length}个频道)`;
                };
                reader.readAsText(file);
            },
            
            handleClear() {
                if (AppState.isChecking) {
                    VideoManager.cleanupAllVideoElements();
                    AppState.isChecking = false;
                }
                
                VideoPlayer.stopCurrentVideo();
                
                DomElements.resultArea.innerHTML = '';
                DomElements.statsDiv.innerHTML = '';
                DomElements.filterInfo.innerHTML = '';
                DomElements.dropArea.innerHTML = '点击或拖拽m3u/txt文件到此处';
                DomElements.checkBtn.disabled = true;
                DomElements.groupBtn.disabled = true;
                DomElements.checkBtn.textContent = '开始检测';
                
                DomElements.timeoutSlider.disabled = false;
                DomElements.concurrentSlider.disabled = false;
                
                VideoManager.cleanupAllVideoElements();
                
                AppState.channels = [];
                AppState.groups = {};
                AppState.displayedChannels = [];
                AppState.selectedGroups.clear();
                AppState.selectedChannels.clear();
                AppState.channelResolutions.clear();
                AppState.activeVideoElements.clear();
                AppState.currentFilter = 'all';
                DomElements.fileInput.value = '';
                DomElements.directUrlInput.value = '';
                DomElements.directStatus.innerHTML = '<small>提示：仅支持同源或无CORS限制的URL。如果导入失败，请下载文件后使用本地导入。</small>';
                
                UI.updateSelectedCount();
                
                if (window.gc) {
                    window.gc();
                }
            },
            
            updateGroupCheckboxes(checked) {
                const checkboxes = DomElements.groupList.querySelectorAll('.group-checkbox');
                if (checkboxes.length > 0) {
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = checked;
                        checkbox.closest('.group-item').classList.toggle('selected', checked);
                    });
                    DomElements.selectedGroupsCount.textContent = AppState.selectedGroups.size;
                    UI.applyFilter('all');
                }
            }
        };
        
        // ==================== 初始化应用 ====================
        const App = {
            init() {
                UI.updateTimeoutDisplay();
                UI.updateConcurrentDisplay();
                UI.updateSelectedCount();
                EventHandlers.init();
            }
        };
        
        // 启动应用
        App.init();
    </script>
</body>
</html>
