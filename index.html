<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直播源检测工具</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Arial,sans-serif;background:#f5f5f5;height:100vh;display:flex;flex-direction:column}
        .container{flex:1;max-width:1200px;margin:0 auto;background:white;padding:15px;border-radius:8px;display:flex;flex-direction:column;height:100%;width:100%}
        h1{color:#333;text-align:center;margin:10px 0 20px;font-size:1.5rem}
        .upload-area{border:2px dashed #ccc;padding:20px;text-align:center;margin:0 0 15px;cursor:pointer;border-radius:6px;transition:all 0.3s}
        .upload-area:hover{border-color:#4CAF50;background-color:#f9f9f9}
        .file-input{display:none}
        .channel{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;min-height:44px}
        .channel-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:10px;display:flex;align-items:center;gap:8px}
        .channel-checkbox{margin-right:8px;width:16px;height:16px;cursor:pointer}
        .resolution-badge{font-size:0.7rem;padding:1px 6px;border-radius:4px;font-weight:600;white-space:nowrap;min-width:40px;text-align:center;border:1px solid transparent}
        /* 分辨率颜色定义 */
        .resolution-4k{background:linear-gradient(135deg, #8A2BE2, #9370DB);color:white;border-color:#8A2BE2}
        .resolution-2k{background:linear-gradient(135deg, #4169E1, #6495ED);color:white;border-color:#4169E1}
        .resolution-1080p{background:linear-gradient(135deg, #1E90FF, #87CEFA);color:white;border-color:#1E90FF}
        .resolution-720p{background:linear-gradient(135deg, #32CD32, #90EE90);color:white;border-color:#32CD32}
        .resolution-480p{background:linear-gradient(135deg, #FFD700, #FFEC8B);color:#8B4513;border-color:#FFD700}
        .resolution-360p{background:linear-gradient(135deg, #FFA500, #FFD700);color:#8B4513;border-color:#FFA500}
        .resolution-240p{background:linear-gradient(135deg, #FF4500, #FF6347);color:white;border-color:#FF4500}
        .resolution-sd{background:linear-gradient(135deg, #A9A9A9, #D3D3D3);color:#333;border-color:#A9A9A9}
        .resolution-unknown{background:linear-gradient(135deg, #808080, #B0B0B0);color:white;border-color:#808080}
        .channel-url{color:#666;font-size:0.85rem;margin-left:10px;font-family:monospace;max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .status{padding:5px 10px;border-radius:4px;margin-left:10px;font-size:0.85rem;white-space:nowrap}
        .valid{background:#d4edda;color:#155724}
        .invalid{background:#f8d7da;color:#721c24}
        .checking{background:#fff3cd;color:#856404}
        .waiting{background:#f0f0f0;color:#666}
        .time{margin-left:10px;color:#666;font-size:0.8rem;white-space:nowrap}
        .stats{margin:10px 0;font-weight:bold;font-size:0.9rem;padding:8px;background:#f8f9fa;border-radius:4px}
        .stats-btn{background:#6c757d;color:white;border:none;padding:3px 8px;cursor:pointer;border-radius:3px;font-size:0.85rem;margin:0 2px;transition:all 0.2s}
        .stats-btn:hover{opacity:0.9;transform:translateY(-1px)}
        .stats-btn.active{box-shadow:0 0 0 2px rgba(0,0,0,0.2)}
        .stats-total{background:#6c757d}
        .stats-valid{background:#28a745}
        .stats-invalid{background:#dc3545}
        .stats-waiting{background:#ffc107;color:#212529}
        .stats-all{background:#007bff}
        .selection-buttons{display:flex;gap:10px;margin:10px 0;justify-content:center;flex-wrap:wrap}
        .selection-btn{padding:8px 15px;font-size:0.85rem;border:none;cursor:pointer;border-radius:4px;transition:all 0.2s}
        .select-valid-btn{background:#28a745;color:white}
        .select-valid-btn:hover{background:#218838}
        .deselect-all-btn{background:#dc3545;color:white}
        .deselect-all-btn:hover{background:#c82333}
        .export-btn{background:#17a2b8;color:white}
        .export-btn:hover{background:#138496}
        .export-hd-btn{background:#ff6b35;color:white}
        .export-hd-btn:hover{background:#e55a2b}
        .export-selected-btn{background:#9c27b0;color:white} /* 新增导出勾选按钮样式 */
        .export-selected-btn:hover{background:#7b1fa2}
        button{background:#4CAF50;color:white;border:none;padding:10px 15px;cursor:pointer;border-radius:4px;font-size:0.9rem;transition:background 0.2s}
        button:hover{background:#45a049}
        button:disabled{background:#ccc;cursor:not-allowed}
        .buttons{display:flex;gap:10px;justify-content:center;margin:15px 0;flex-wrap:wrap}
        .group-btn{background:#007bff}
        .group-btn:hover{background:#0069d9}
        .clear-btn{background:#6c757d}
        .clear-btn:hover{background:#5a6268}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000}
        .modal-content{background:white;padding:20px;border-radius:8px;max-width:95%;width:800px;max-height:90vh;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:1.2rem;font-weight:bold}
        .close-btn{font-size:24px;cursor:pointer;padding:0 10px}
        .group-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
        .group-item{padding:10px;background:#f8f9fa;border-radius:4px;text-align:left;position:relative;cursor:pointer;transition:all 0.2s}
        .group-item:hover{transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .group-item.selected{background:#e3f2fd;border:1px solid #2196F3}
        .group-name{font-weight:bold;margin-bottom:5px;display:flex;align-items:center}
        .group-count{font-size:0.8rem;color:#666}
        .show{display:flex}
        .result-area{flex:1;overflow-y:auto;margin-top:10px;border:1px solid #ddd;border-radius:4px;padding:10px}
        .group-checkbox{margin-right:8px;width:16px;height:16px;cursor:pointer}
        .group-select-actions{display:flex;gap:10px;margin-bottom:15px}
        .group-select-btn{padding:8px 15px;font-size:0.85rem}
        .select-all-btn{background:#28a745}
        .select-all-btn:hover{background:#218838}
        .deselect-all-group-btn{background:#dc3545}
        .deselect-all-group-btn:hover{background:#c82333}
        .settings{padding:15px;margin-bottom:15px;background:#f8f9fa;border-radius:6px;display:flex;flex-direction:column;gap:15px}
        .setting-item{display:flex;align-items:center;gap:10px}
        .setting-label{font-weight:bold;min-width:120px}
        .slider-container{display:flex;align-items:center;gap:10px;flex:1}
        .slider{flex:1;height:6px;-webkit-appearance:none;appearance:none;background:#ddd;border-radius:3px;outline:none}
        .slider::-webkit-slider-thumb{width:20px;height:20px;border-radius:50%;cursor:pointer;-webkit-appearance:none}
        .slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;cursor:pointer;border:none}
        .slider-value{font-weight:bold;min-width:40px;text-align:center}
        .timeout-slider::-webkit-slider-thumb{background:#4CAF50}
        .timeout-slider::-moz-range-thumb{background:#4CAF50}
        .timeout-value{color:#4CAF50}
        .concurrent-slider::-webkit-slider-thumb{background:#2196F3}
        .concurrent-slider::-moz-range-thumb{background:#2196F3}
        .concurrent-value{color:#2196F3}
        .settings-row{display:flex;gap:20px}
        .settings-column{flex:1;display:flex;flex-direction:column;gap:15px}
        .performance-warning{font-size:0.8rem;color:#dc3545;text-align:center;padding:5px;background:#f8d7da;border-radius:4px;margin-bottom:10px;display:none}
        .resolution-legend{margin-top:10px;display:flex;flex-wrap:wrap;gap:5px;justify-content:center}
        .legend-item{display:flex;align-items:center;gap:3px;font-size:0.7rem;padding:2px 5px;border-radius:3px}
        .filter-info{margin-top:5px;font-size:0.8rem;color:#666;text-align:center}
        .selected-count{margin-left:10px;font-weight:bold;color:#28a745}
        @media (max-width:768px){
            .container{padding:10px;margin:0;border-radius:0}
            .modal-content{padding:15px;max-width:98%}
            .group-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
            .buttons{flex-direction:column;align-items:stretch}
            button{width:100%}
            .selection-buttons{flex-direction:column;align-items:stretch}
            .selection-btn{width:100%}
            .channel{flex-wrap:wrap}
            .channel-name{flex-basis:100%;margin-bottom:5px}
            .channel-url{flex-basis:100%;margin-left:0;margin-bottom:5px;max-width:100%}
            .status,.time{margin-left:0;margin-right:10px}
            .settings{flex-direction:column;gap:10px}
            .setting-item{flex-direction:column;align-items:flex-start;gap:5px}
            .setting-label{min-width:auto}
            .slider-container{width:100%}
            .settings-row{flex-direction:column;gap:15px}
            .resolution-legend{justify-content:flex-start;gap:3px}
            .stats-btn{font-size:0.8rem;padding:2px 5px;margin:0 1px}
        }
        @media (max-width:480px){
            h1{font-size:1.2rem}
            .upload-area{padding:15px}
            .group-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
            .channel-url{font-size:0.75rem}
            .resolution-badge{font-size:0.6rem;padding:0 4px;min-width:35px}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>直播源检测工具</h1>
        <div class="upload-area" id="dropArea">
            点击或拖拽m3u/txt文件到此处
            <input type="file" id="fileInput" class="file-input" accept=".m3u,.txt">
        </div>
        
        <div class="performance-warning" id="performanceWarning">
            注意：高并发检测可能导致浏览器内存占用过高，建议并发数不超过5个
        </div>
        
        <div class="settings">
            <div class="settings-row">
                <div class="settings-column">
                    <div class="setting-item">
                        <div class="setting-label">检测超时时间:</div>
                        <div class="slider-container">
                            <input type="range" id="timeoutSlider" class="slider timeout-slider" min="1" max="20" value="10" step="1">
                            <div class="slider-value timeout-value" id="timeoutValue">10秒</div>
                        </div>
                    </div>
                </div>
                <div class="settings-column">
                    <div class="setting-item">
                        <div class="setting-label">并发检测数量:</div>
                        <div class="slider-container">
                            <input type="range" id="concurrentSlider" class="slider concurrent-slider" min="1" max="20" value="3" step="1">
                            <div class="slider-value concurrent-value" id="concurrentValue">3个</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="resolution-legend" id="resolutionLegend">
            <div class="legend-item resolution-4k">4K</div>
            <div class="legend-item resolution-2k">2K</div>
            <div class="legend-item resolution-1080p">1080p</div>
            <div class="legend-item resolution-720p">720p</div>
            <div class="legend-item resolution-480p">480p</div>
            <div class="legend-item resolution-360p">360p</div>
            <div class="legend-item resolution-240p">240p</div>
            <div class="legend-item resolution-sd">SD</div>
            <div class="legend-item resolution-unknown">未知</div>
        </div>
        
        <div class="buttons">
            <button id="checkBtn" disabled>开始检测</button>
            <button id="groupBtn" class="group-btn" disabled>分组显示</button>
            <button id="clearBtn" class="clear-btn">清除</button>
        </div>
        
        <div class="stats" id="stats"></div>
        <div class="filter-info" id="filterInfo"></div>
        
        <div class="selection-buttons">
            <button id="selectValidBtn" class="selection-btn select-valid-btn">有效全部勾选</button>
            <button id="deselectAllBtn" class="selection-btn deselect-all-btn">全部取消勾选</button>
            <button id="exportSelectedBtn" class="selection-btn export-selected-btn">导出勾选</button> <!-- 新增按钮 -->
            <button id="exportHDChannelsBtn" class="selection-btn export-hd-btn">导出高清频道</button>
            <button id="exportAllValidBtn" class="selection-btn export-btn">导出全部有效</button>
            <span class="selected-count" id="selectedCount">已选中: 0</span>
        </div>
        
        <div class="result-area" id="resultArea"></div>
    </div>

    <div class="modal" id="groupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">分组信息 (已选择 <span id="selectedGroupsCount">0</span>/<span id="totalGroupsCount">0</span>)</div>
                <div class="close-btn" id="closeModal">×</div>
            </div>
            <div class="group-select-actions">
                <button id="selectAllGroupsBtn" class="group-select-btn select-all-btn">全选</button>
                <button id="deselectAllGroupsBtn" class="group-select-btn deselect-all-group-btn">全不选</button>
            </div>
            <div id="groupList" class="group-grid"></div>
        </div>
    </div>

    <script>
        const elements = {
            fileInput: document.getElementById('fileInput'),
            dropArea: document.getElementById('dropArea'),
            checkBtn: document.getElementById('checkBtn'),
            groupBtn: document.getElementById('groupBtn'),
            clearBtn: document.getElementById('clearBtn'),
            resultArea: document.getElementById('resultArea'),
            statsDiv: document.getElementById('stats'),
            filterInfo: document.getElementById('filterInfo'),
            groupModal: document.getElementById('groupModal'),
            groupList: document.getElementById('groupList'),
            closeModal: document.getElementById('closeModal'),
            selectAllGroupsBtn: document.getElementById('selectAllGroupsBtn'),
            deselectAllGroupsBtn: document.getElementById('deselectAllGroupsBtn'),
            selectedGroupsCount: document.getElementById('selectedGroupsCount'),
            totalGroupsCount: document.getElementById('totalGroupsCount'),
            timeoutSlider: document.getElementById('timeoutSlider'),
            timeoutValue: document.getElementById('timeoutValue'),
            concurrentSlider: document.getElementById('concurrentSlider'),
            concurrentValue: document.getElementById('concurrentValue'),
            performanceWarning: document.getElementById('performanceWarning'),
            resolutionLegend: document.getElementById('resolutionLegend'),
            selectValidBtn: document.getElementById('selectValidBtn'),
            deselectAllBtn: document.getElementById('deselectAllBtn'),
            exportSelectedBtn: document.getElementById('exportSelectedBtn'), // 新增按钮
            exportHDChannelsBtn: document.getElementById('exportHDChannelsBtn'),
            exportAllValidBtn: document.getElementById('exportAllValidBtn'),
            selectedCount: document.getElementById('selectedCount')
        };
        
        let channels = [], groups = {}, isChecking = false, selectedGroups = new Set(), displayedChannels = [];
        let timeoutSeconds = parseInt(elements.timeoutSlider.value);
        let concurrentLimit = parseInt(elements.concurrentSlider.value);
        
        let activeVideoElements = new Map();
        let videoElementCounter = 0;
        
        let currentFilter = 'all';
        let selectedChannels = new Set();
        
        // 新增：用于存储视频宽高信息
        let channelResolutions = new Map();
        
        // 更新超时时间显示
        function updateTimeoutDisplay() {
            elements.timeoutValue.textContent = `${timeoutSeconds}秒`;
        }
        
        // 更新并发数量显示
        function updateConcurrentDisplay() {
            elements.concurrentValue.textContent = `${concurrentLimit}个`;
            
            if (concurrentLimit > 5) {
                elements.performanceWarning.style.display = 'block';
            } else {
                elements.performanceWarning.style.display = 'none';
            }
        }
        
        // 更新选中频道计数
        function updateSelectedCount() {
            const count = selectedChannels.size;
            elements.selectedCount.textContent = `已选中: ${count}`;
        }
        
        // 监听滑块变化
        elements.timeoutSlider.addEventListener('input', () => {
            timeoutSeconds = parseInt(elements.timeoutSlider.value);
            updateTimeoutDisplay();
        });
        
        elements.concurrentSlider.addEventListener('input', () => {
            concurrentLimit = parseInt(elements.concurrentSlider.value);
            updateConcurrentDisplay();
        });
        
        // 初始化显示
        updateTimeoutDisplay();
        updateConcurrentDisplay();
        
        // 强制清理视频元素的函数
        function forceCleanupVideoElement(videoId) {
            if (!activeVideoElements.has(videoId)) return;
            
            const videoInfo = activeVideoElements.get(videoId);
            if (videoInfo && videoInfo.video) {
                const video = videoInfo.video;
                
                try {
                    video.onloadeddata = null;
                    video.oncanplay = null;
                    video.onerror = null;
                    video.onstalled = null;
                    video.onsuspend = null;
                    video.onabort = null;
                    
                    video.pause();
                    video.currentTime = 0;
                    
                    video.src = '';
                    video.removeAttribute('src');
                    
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    }
                    
                    if (video.parentNode) {
                        video.parentNode.removeChild(video);
                    }
                    
                    video.load();
                    
                    for (let prop in video) {
                        try {
                            if (typeof video[prop] === 'function') {
                                video[prop] = null;
                            }
                        } catch (e) {}
                    }
                    
                    videoInfo.video = null;
                    
                } catch (error) {
                    console.warn('清理视频元素时出错:', error);
                } finally {
                    activeVideoElements.delete(videoId);
                    
                    setTimeout(() => {
                        const temp = new Array(1000).fill(0);
                        temp.length = 0;
                    }, 0);
                }
            }
        }
        
        // 清理所有活动的视频元素
        function cleanupAllVideoElements() {
            const videoIds = Array.from(activeVideoElements.keys());
            for (const videoId of videoIds) {
                forceCleanupVideoElement(videoId);
            }
            activeVideoElements.clear();
        }
        
        // 安全的视频元素创建和注册
        function createVideoElement() {
            const videoId = `video_${Date.now()}_${videoElementCounter++}`;
            const video = document.createElement('video');
            
            video.setAttribute('preload', 'auto');
            video.setAttribute('playsinline', '');
            video.setAttribute('webkit-playsinline', '');
            video.muted = true;
            video.volume = 0;
            video.style.display = 'none';
            video.style.position = 'absolute';
            video.style.top = '-9999px';
            video.style.left = '-9999px';
            video.style.width = '1px';
            video.style.height = '1px';
            
            activeVideoElements.set(videoId, { video, cleanupTimeout: null });
            
            document.body.appendChild(video);
            
            return { videoId, video };
        }
        
        // 安全的视频元素清理
        function safeVideoCleanup(videoId, delay = 100) {
            return new Promise(resolve => {
                if (activeVideoElements.has(videoId)) {
                    const videoInfo = activeVideoElements.get(videoId);
                    
                    if (videoInfo.cleanupTimeout) {
                        clearTimeout(videoInfo.cleanupTimeout);
                    }
                    
                    videoInfo.cleanupTimeout = setTimeout(() => {
                        forceCleanupVideoElement(videoId);
                        setTimeout(resolve, 50);
                    }, delay);
                } else {
                    resolve();
                }
            });
        }
        
        // 获取分辨率描述和对应的CSS类名
        function getResolutionInfo(width, height) {
            if (!width || !height) return { description: '未知分辨率', className: 'resolution-unknown' };
            
            const resolutions = [
                { minWidth: 3840, minHeight: 2160, description: '4K', className: 'resolution-4k' },
                { minWidth: 2560, minHeight: 1440, description: '2K', className: 'resolution-2k' },
                { minWidth: 1920, minHeight: 1080, description: '1080p', className: 'resolution-1080p' },
                { minWidth: 1280, minHeight: 720, description: '720p', className: 'resolution-720p' },
                { minWidth: 854, minHeight: 480, description: '480p', className: 'resolution-480p' },
                { minWidth: 640, minHeight: 360, description: '360p', className: 'resolution-360p' },
                { minWidth: 426, minHeight: 240, description: '240p', className: 'resolution-240p' }
            ];
            
            for (const res of resolutions) {
                if (width >= res.minWidth && height >= res.minHeight) {
                    return { description: res.description, className: res.className };
                }
            }
            
            if (width >= 640 && height >= 480) {
                return { description: 'SD', className: 'resolution-sd' };
            }
            
            return { description: `${width}×${height}`, className: 'resolution-unknown' };
        }
        
        // 判断是否为高清频道（1080p及以上）
        function isHDChannel(channel) {
            // 首先检查是否有存储的分辨率宽高信息
            const resolutionInfo = channelResolutions.get(channels.indexOf(channel));
            if (resolutionInfo && resolutionInfo.width && resolutionInfo.height) {
                // 1080p标准：1920×1080
                return resolutionInfo.width >= 1920 && resolutionInfo.height >= 1080;
            }
            
            // 如果没有宽高信息，检查分辨率描述
            if (channel.resolution) {
                const hdResolutions = ['1080p', '2K', '4K'];
                return hdResolutions.some(res => channel.resolution.includes(res));
            }
            
            return false;
        }
        
        // 毫秒转秒
        function msToSeconds(ms) {
            return (ms / 1000).toFixed(2);
        }
        
        // 根据筛选状态获取频道列表
        function getFilteredChannels(filter) {
            const channelsInSelectedGroups = channels.filter(channel => selectedGroups.has(channel.group));
            
            switch(filter) {
                case 'valid':
                    return channelsInSelectedGroups.filter(c => c.valid === true);
                case 'invalid':
                    return channelsInSelectedGroups.filter(c => c.valid === false);
                case 'waiting':
                    return channelsInSelectedGroups.filter(c => c.valid === null);
                case 'all':
                default:
                    return channelsInSelectedGroups;
            }
        }
        
        // 应用筛选
        function applyFilter(filter) {
            currentFilter = filter;
            displayChannels();
            updateFilterInfo();
        }
        
        // 更新筛选信息显示
        function updateFilterInfo() {
            const filterTexts = {
                'all': '显示全部频道',
                'valid': '只显示有效频道',
                'invalid': '只显示无效频道',
                'waiting': '只显示等待检测频道'
            };
            
            elements.filterInfo.textContent = filterTexts[currentFilter] || '';
        }
        
        // 勾选全部有效频道
        function selectAllValidChannels() {
            const filteredChannels = getFilteredChannels(currentFilter);
            const validChannels = filteredChannels.filter(channel => channel.valid === true);
            
            validChannels.forEach(channel => {
                selectedChannels.add(channel);
            });
            
            updateCheckboxStates();
            updateSelectedCount();
        }
        
        // 取消所有勾选
        function deselectAllChannels() {
            selectedChannels.clear();
            updateCheckboxStates();
            updateSelectedCount();
        }
        
        // 更新所有复选框的状态
        function updateCheckboxStates() {
            displayedChannels.forEach((item, index) => {
                const checkbox = document.getElementById(`channel-checkbox-${index}`);
                if (checkbox) {
                    checkbox.checked = selectedChannels.has(item.channel);
                }
            });
        }
        
        // 新增：导出勾选的频道
        function exportSelectedChannels() {
            // 获取勾选的频道
            const selectedChannelsList = Array.from(selectedChannels);
            
            if (selectedChannelsList.length === 0) {
                alert('没有勾选的频道可以导出');
                return;
            }
            
            // 创建M3U格式的内容
            let m3uContent = '#EXTM3U\n';
            let txtContent = '';
            
            // 按分组组织频道
            const groupedChannels = {};
            
            selectedChannelsList.forEach(channel => {
                if (!groupedChannels[channel.group]) {
                    groupedChannels[channel.group] = [];
                }
                groupedChannels[channel.group].push(channel);
            });
            
            // 生成M3U格式
            Object.keys(groupedChannels).forEach(group => {
                groupedChannels[group].forEach(channel => {
                    const resolution = channel.resolution ? ` [${channel.resolution}]` : '';
                    m3uContent += `#EXTINF:-1 group-title="${group}",${channel.name}${resolution}\n`;
                    m3uContent += `${channel.url}\n`;
                });
            });
            
            // 生成TXT格式
            Object.keys(groupedChannels).forEach(group => {
                txtContent += `${group},#genre#\n`;
                groupedChannels[group].forEach(channel => {
                    const resolution = channel.resolution ? ` [${channel.resolution}]` : '';
                    txtContent += `${channel.name}${resolution},${channel.url}\n`;
                });
            });
            
            // 创建下载链接
            const m3uBlob = new Blob([m3uContent], { type: 'application/vnd.apple.mpegurl' });
            const txtBlob = new Blob([txtContent], { type: 'text/plain' });
            
            // 提供两种格式下载
            const m3uLink = document.createElement('a');
            m3uLink.href = URL.createObjectURL(m3uBlob);
            m3uLink.download = `selected_channels_${new Date().getTime()}.m3u`;
            document.body.appendChild(m3uLink);
            m3uLink.click();
            document.body.removeChild(m3uLink);
            
            const txtLink = document.createElement('a');
            txtLink.href = URL.createObjectURL(txtBlob);
            txtLink.download = `selected_channels_${new Date().getTime()}.txt`;
            document.body.appendChild(txtLink);
            txtLink.click();
            document.body.removeChild(txtLink);
            
            alert(`已导出 ${selectedChannelsList.length} 个勾选频道`);
        }
        
        // 导出高清频道（1080p及以上）
        function exportHDChannels() {
            // 获取高清频道（有效且为1080p及以上）
            const hdChannels = channels.filter(channel => 
                selectedGroups.has(channel.group) && 
                channel.valid === true && 
                isHDChannel(channel)
            );
            
            if (hdChannels.length === 0) {
                alert('没有找到1080p及以上的高清频道');
                return;
            }
            
            // 创建M3U格式的内容
            let m3uContent = '#EXTM3U\n';
            let txtContent = '';
            
            // 按分组组织频道
            const groupedChannels = {};
            
            hdChannels.forEach(channel => {
                if (!groupedChannels[channel.group]) {
                    groupedChannels[channel.group] = [];
                }
                groupedChannels[channel.group].push(channel);
            });
            
            // 生成M3U格式
            Object.keys(groupedChannels).forEach(group => {
                groupedChannels[group].forEach(channel => {
                    const resolution = channel.resolution ? ` [${channel.resolution}]` : '';
                    m3uContent += `#EXTINF:-1 group-title="${group}",${channel.name}${resolution}\n`;
                    m3uContent += `${channel.url}\n`;
                });
            });
            
            // 生成TXT格式
            Object.keys(groupedChannels).forEach(group => {
                txtContent += `${group},#genre#\n`;
                groupedChannels[group].forEach(channel => {
                    const resolution = channel.resolution ? ` [${channel.resolution}]` : '';
                    txtContent += `${channel.name}${resolution},${channel.url}\n`;
                });
            });
            
            // 创建下载链接
            const m3uBlob = new Blob([m3uContent], { type: 'application/vnd.apple.mpegurl' });
            const txtBlob = new Blob([txtContent], { type: 'text/plain' });
            
            // 提供两种格式下载
            const m3uLink = document.createElement('a');
            m3uLink.href = URL.createObjectURL(m3uBlob);
            m3uLink.download = `hd_channels_${new Date().getTime()}.m3u`;
            document.body.appendChild(m3uLink);
            m3uLink.click();
            document.body.removeChild(m3uLink);
            
            const txtLink = document.createElement('a');
            txtLink.href = URL.createObjectURL(txtBlob);
            txtLink.download = `hd_channels_${new Date().getTime()}.txt`;
            document.body.appendChild(txtLink);
            txtLink.click();
            document.body.removeChild(txtLink);
            
            alert(`已导出 ${hdChannels.length} 个高清频道（1080p及以上）`);
        }
        
        // 导出全部有效频道
        function exportAllValidChannels() {
            // 获取所有有效频道
            const validChannels = channels.filter(channel => 
                selectedGroups.has(channel.group) && channel.valid === true
            );
            
            if (validChannels.length === 0) {
                alert('没有有效频道可以导出');
                return;
            }
            
            // 创建M3U格式的内容
            let m3uContent = '#EXTM3U\n';
            let txtContent = '';
            
            // 按分组组织频道
            const groupedChannels = {};
            
            validChannels.forEach(channel => {
                if (!groupedChannels[channel.group]) {
                    groupedChannels[channel.group] = [];
                }
                groupedChannels[channel.group].push(channel);
            });
            
            // 生成M3U格式
            Object.keys(groupedChannels).forEach(group => {
                groupedChannels[group].forEach(channel => {
                    const resolution = channel.resolution ? ` [${channel.resolution}]` : '';
                    m3uContent += `#EXTINF:-1 group-title="${group}",${channel.name}${resolution}\n`;
                    m3uContent += `${channel.url}\n`;
                });
            });
            
            // 生成TXT格式
            Object.keys(groupedChannels).forEach(group => {
                txtContent += `${group},#genre#\n`;
                groupedChannels[group].forEach(channel => {
                    const resolution = channel.resolution ? ` [${channel.resolution}]` : '';
                    txtContent += `${channel.name}${resolution},${channel.url}\n`;
                });
            });
            
            // 创建下载链接
            const m3uBlob = new Blob([m3uContent], { type: 'application/vnd.apple.mpegurl' });
            const txtBlob = new Blob([txtContent], { type: 'text/plain' });
            
            // 提供两种格式下载
            const m3uLink = document.createElement('a');
            m3uLink.href = URL.createObjectURL(m3uBlob);
            m3uLink.download = `all_valid_channels_${new Date().getTime()}.m3u`;
            document.body.appendChild(m3uLink);
            m3uLink.click();
            document.body.removeChild(m3uLink);
            
            const txtLink = document.createElement('a');
            txtLink.href = URL.createObjectURL(txtBlob);
            txtLink.download = `all_valid_channels_${new Date().getTime()}.txt`;
            document.body.appendChild(txtLink);
            txtLink.click();
            document.body.removeChild(txtLink);
            
            alert(`已导出 ${validChannels.length} 个有效频道`);
        }
        
        elements.dropArea.addEventListener('click', () => elements.fileInput.click());
        elements.dropArea.addEventListener('dragover', (e) => { e.preventDefault(); elements.dropArea.style.borderColor = '#4CAF50' });
        elements.dropArea.addEventListener('dragleave', () => elements.dropArea.style.borderColor = '#ccc');
        elements.dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.dropArea.style.borderColor = '#ccc';
            if (e.dataTransfer.files.length) {
                elements.fileInput.files = e.dataTransfer.files;
                handleFile(e.dataTransfer.files[0]);
            }
        });
        elements.fileInput.addEventListener('change', (e) => e.target.files.length && handleFile(e.target.files[0]));
        
        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                parseFile(e.target.result);
                applyFilter('all');
                elements.checkBtn.disabled = false;
                elements.groupBtn.disabled = false;
                elements.dropArea.innerHTML = `已加载: ${file.name} (${channels.length}个频道)`;
            };
            reader.readAsText(file);
        }
        
        function parseFile(content) {
            channels = []; groups = {}; selectedGroups.clear(); displayedChannels = [];
            selectedChannels.clear();
            channelResolutions.clear();
            updateSelectedCount();
            const lines = content.split('\n');
            const isM3UFormat = lines.some(line => line.includes('#EXTINF'));
            isM3UFormat ? parseM3UFormat(lines) : parseTXTFormat(lines);
            Object.keys(groups).forEach(group => selectedGroups.add(group));
        }
        
        function parseM3UFormat(lines) {
            let currentName = '', currentGroup = '未分组';
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF')) {
                    const nameMatch = line.match(/,(.*)/);
                    if (nameMatch) currentName = nameMatch[1];
                    const groupMatch = line.match(/group-title="([^"]+)"/);
                    if (groupMatch) currentGroup = groupMatch[1];
                } else if (line.startsWith('http')) {
                    addChannel(currentName || '未命名频道', line, currentGroup);
                    currentName = ''; currentGroup = '未分组';
                }
            }
        }
        
        function parseTXTFormat(lines) {
            let currentGroup = '未分组';
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                if (line.includes(',#genre#')) {
                    const firstCommaIndex = line.indexOf(',');
                    if (firstCommaIndex !== -1) {
                        const groupName = line.substring(0, firstCommaIndex).trim();
                        if (groupName) { currentGroup = groupName; if (!groups[currentGroup]) groups[currentGroup] = []; }
                    }
                    continue;
                }
                if (line.includes(',') && line.includes('http')) {
                    const firstCommaIndex = line.indexOf(',');
                    const channelName = line.substring(0, firstCommaIndex).trim();
                    const channelUrl = line.substring(firstCommaIndex + 1).trim();
                    if (channelUrl.startsWith('http')) addChannel(channelName || '未命名频道', channelUrl, currentGroup);
                } else if (line.startsWith('http')) addChannel('未命名频道', line, currentGroup);
            }
            if (Object.keys(groups).length === 0 && channels.length > 0) {
                groups['未分组'] = [...channels];
                channels.forEach(channel => channel.group = '未分组');
            }
        }
        
        function addChannel(name, url, group) {
            const channel = { 
                name, 
                url, 
                group, 
                valid: null, 
                time: null, 
                resolution: null,
                resolutionClass: null 
            };
            channels.push(channel);
            if (!groups[group]) groups[group] = [];
            groups[group].push(channel);
        }
        
        function displayChannels() {
            elements.resultArea.innerHTML = '';
            displayedChannels = [];
            
            // 获取筛选后的频道
            const channelsToDisplay = getFilteredChannels(currentFilter);
            
            channelsToDisplay.forEach((channel, index) => {
                const channelDiv = document.createElement('div');
                channelDiv.className = 'channel';
                channelDiv.id = `channel-display-${index}`;
                
                // 创建分辨率徽章
                let resolutionBadge = '';
                if (channel.resolution) {
                    const resolutionClass = channel.resolutionClass || 'resolution-unknown';
                    resolutionBadge = `<span class="resolution-badge ${resolutionClass}" id="resolution-${index}">${channel.resolution}</span>`;
                } else {
                    resolutionBadge = `<span class="resolution-badge" id="resolution-${index}" style="display:none"></span>`;
                }
                
                // 设置状态显示
                let statusText = '等待检测';
                let statusClass = 'waiting';
                if (channel.valid === true) {
                    statusText = '有效';
                    statusClass = 'valid';
                } else if (channel.valid === false) {
                    statusText = '无效';
                    statusClass = 'invalid';
                }
                
                // 只有有效频道才能勾选
                const checkboxDisabled = channel.valid !== true ? 'disabled' : '';
                const isChecked = selectedChannels.has(channel) ? 'checked' : '';
                
                channelDiv.innerHTML = `
                    <div class="channel-name">
                        <input type="checkbox" id="channel-checkbox-${index}" class="channel-checkbox" 
                               ${checkboxDisabled} ${isChecked} data-channel-index="${index}">
                        ${channel.name}
                        ${resolutionBadge}
                    </div>
                    <div class="channel-url" title="${channel.url}">${channel.url}</div>
                    <div class="status ${statusClass}">${statusText}</div>
                    <div class="time">${channel.time ? `${msToSeconds(channel.time)}s` : '-'}</div>
                `;
                elements.resultArea.appendChild(channelDiv);
                displayedChannels.push({ channel, displayIndex: index, originalIndex: channels.indexOf(channel) });
            });
            
            // 为所有复选框添加事件监听
            displayedChannels.forEach((item, index) => {
                const checkbox = document.getElementById(`channel-checkbox-${index}`);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedChannels.add(item.channel);
                        } else {
                            selectedChannels.delete(item.channel);
                        }
                        updateSelectedCount();
                    });
                }
            });
            
            updateStats();
        }
        
        // 更新分辨率显示
        function updateResolutionDisplay(displayIndex, resolution, className) {
            const resolutionElement = document.getElementById(`resolution-${displayIndex}`);
            if (resolutionElement) {
                resolutionElement.textContent = resolution;
                resolutionElement.className = `resolution-badge ${className}`;
                resolutionElement.style.display = resolution ? 'inline' : 'none';
            }
        }
        
        function showGroupModal() {
            elements.groupList.innerHTML = '';
            elements.totalGroupsCount.textContent = Object.keys(groups).length;
            elements.selectedGroupsCount.textContent = selectedGroups.size;
            const fragment = document.createDocumentFragment();
            Object.keys(groups).sort().forEach(groupName => {
                const groupItem = document.createElement('div');
                groupItem.className = selectedGroups.has(groupName) ? 'group-item selected' : 'group-item';
                groupItem.innerHTML = `
                    <div class="group-name">
                        <input type="checkbox" class="group-checkbox" ${selectedGroups.has(groupName) ? 'checked' : ''} data-group="${groupName}">
                        ${groupName}
                    </div>
                    <div class="group-count">${groups[groupName].length}个频道</div>
                `;
                fragment.appendChild(groupItem);
            });
            elements.groupList.appendChild(fragment);
            elements.groupList.querySelectorAll('.group-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const groupName = this.dataset.group;
                    if (this.checked) selectedGroups.add(groupName);
                    else selectedGroups.delete(groupName);
                    this.closest('.group-item').classList.toggle('selected', this.checked);
                    elements.selectedGroupsCount.textContent = selectedGroups.size;
                    applyFilter(currentFilter);
                });
            });
            elements.groupModal.classList.add('show');
        }
        
        // 检测单个频道（带强制清理和分辨率检测）
        async function checkChannel(channel, displayIndex) {
            const channelDiv = document.getElementById(`channel-display-${displayIndex}`);
            if (!channelDiv) return false;
            
            const statusEl = channelDiv.querySelector('.status');
            const timeEl = channelDiv.querySelector('.time');
            statusEl.className = 'status checking';
            statusEl.textContent = '检测中...';
            const startTime = Date.now();
            
            // 检查URL协议
            if (!channel.url.startsWith('http')) {
                channel.valid = false;
                statusEl.className = 'status invalid';
                statusEl.textContent = '无效协议';
                timeEl.textContent = `${msToSeconds(Date.now() - startTime)}s`;
                updateStats();
                return false;
            }
            
            return new Promise(async (resolve) => {
                let videoId = null;
                let timeoutId = null;
                let hasResolved = false;
                let videoElement = null;
                
                const resolveWithCleanup = (result, resolutionInfo = null, width = null, height = null) => {
                    if (hasResolved) return;
                    hasResolved = true;
                    
                    // 保存分辨率信息
                    if (resolutionInfo) {
                        channel.resolution = resolutionInfo.description;
                        channel.resolutionClass = resolutionInfo.className;
                        updateResolutionDisplay(displayIndex, resolutionInfo.description, resolutionInfo.className);
                    }
                    
                    // 新增：存储视频宽高信息
                    if (width && height) {
                        const channelIndex = channels.indexOf(channel);
                        channelResolutions.set(channelIndex, { width, height });
                    }
                    
                    // 清理超时
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                        timeoutId = null;
                    }
                    
                    // 强制清理视频元素
                    if (videoId) {
                        safeVideoCleanup(videoId, 100).then(() => {
                            setTimeout(() => resolve(result), 50);
                        });
                    } else {
                        resolve(result);
                    }
                };
                
                try {
                    // 创建视频元素
                    const videoInfo = createVideoElement();
                    videoId = videoInfo.videoId;
                    videoElement = videoInfo.video;
                    
                    // 设置超时
                    const timeoutMs = timeoutSeconds * 1000;
                    timeoutId = setTimeout(() => {
                        channel.valid = false;
                        statusEl.className = 'status invalid';
                        statusEl.textContent = `超时(${timeoutSeconds}s)`;
                        timeEl.textContent = `${msToSeconds(Date.now() - startTime)}s`;
                        updateStats();
                        resolveWithCleanup(false);
                    }, timeoutMs);
                    
                    // 标志位
                    let loadeddataTriggered = false;
                    let canplayTriggered = false;
                    
                    // 分辨率检测函数
                    const checkResolution = () => {
                        try {
                            if (videoElement && videoElement.videoWidth && videoElement.videoHeight) {
                                return {
                                    resolutionInfo: getResolutionInfo(videoElement.videoWidth, videoElement.videoHeight),
                                    width: videoElement.videoWidth,
                                    height: videoElement.videoHeight
                                };
                            }
                        } catch (e) {
                            console.warn('获取分辨率失败:', e);
                        }
                        return null;
                    };
                    
                    // loadeddata事件回调
                    const onLoadedData = () => {
                        loadeddataTriggered = true;
                        checkBothEvents();
                    };
                    
                    // canplay事件回调
                    const onCanPlay = () => {
                        canplayTriggered = true;
                        checkBothEvents();
                    };
                    
                    // 检查两个事件是否都触发了
                    const checkBothEvents = () => {
                        if (loadeddataTriggered && canplayTriggered && !hasResolved) {
                            // 尝试获取分辨率
                            const resolutionData = checkResolution();
                            
                            channel.valid = true;
                            statusEl.className = 'status valid';
                            statusEl.textContent = '有效';
                            timeEl.textContent = `${msToSeconds(Date.now() - startTime)}s`;
                            updateStats();
                            
                            if (resolutionData) {
                                resolveWithCleanup(true, resolutionData.resolutionInfo, resolutionData.width, resolutionData.height);
                            } else {
                                resolveWithCleanup(true);
                            }
                        }
                    };
                    
                    // 错误回调
                    const onError = () => {
                        if (!hasResolved) {
                            channel.valid = false;
                            statusEl.className = 'status invalid';
                            statusEl.textContent = '无法播放';
                            timeEl.textContent = `${msToSeconds(Date.now() - startTime)}s`;
                            updateStats();
                            resolveWithCleanup(false);
                        }
                    };
                    
                    // 添加一次性事件监听器
                    videoElement.addEventListener('loadeddata', onLoadedData, { once: true });
                    videoElement.addEventListener('canplay', onCanPlay, { once: true });
                    videoElement.addEventListener('error', onError, { once: true });
                    
                    // 添加loadedmetadata事件来检测分辨率
                    videoElement.addEventListener('loadedmetadata', () => {
                        if (!hasResolved && videoElement) {
                            // 如果已经触发两个事件，但还没有分辨率，再次尝试获取
                            if (loadeddataTriggered && canplayTriggered) {
                                const resolutionData = checkResolution();
                                if (resolutionData && channel.valid === true) {
                                    channel.resolution = resolutionData.resolutionInfo.description;
                                    channel.resolutionClass = resolutionData.resolutionInfo.className;
                                    updateResolutionDisplay(displayIndex, resolutionData.resolutionInfo.description, resolutionData.resolutionInfo.className);
                                    
                                    // 存储宽高信息
                                    const channelIndex = channels.indexOf(channel);
                                    channelResolutions.set(channelIndex, { 
                                        width: resolutionData.width, 
                                        height: resolutionData.height 
                                    });
                                }
                            }
                        }
                    }, { once: true });
                    
                    // 开始加载视频
                    videoElement.src = channel.url;
                    videoElement.load();
                    
                } catch (error) {
                    console.error('检测过程中发生错误:', error);
                    channel.valid = false;
                    statusEl.className = 'status invalid';
                    statusEl.textContent = '检测失败';
                    timeEl.textContent = `${msToSeconds(Date.now() - startTime)}s`;
                    updateStats();
                    resolveWithCleanup(false);
                }
            });
        }
        
        // 安全的并发检测函数
        async function checkChannelsSafely() {
            const executing = new Set();
            const results = [];
            
            for (let i = 0; i < displayedChannels.length; i++) {
                const item = displayedChannels[i];
                
                // 检查是否有太多活动元素
                if (activeVideoElements.size >= concurrentLimit) {
                    // 等待至少一个任务完成
                    await Promise.race(executing);
                }
                
                // 创建检测Promise
                const promise = checkChannel(item.channel, item.displayIndex)
                    .finally(() => {
                        executing.delete(promise);
                    });
                
                executing.add(promise);
                results.push(promise);
                
                // 如果达到并发限制，等待至少一个完成
                if (executing.size >= concurrentLimit) {
                    await Promise.race(executing);
                }
            }
            
            // 等待所有任务完成
            await Promise.all(results);
            
            // 强制清理所有剩余的视频元素
            cleanupAllVideoElements();
        }
        
        function updateStats() {
            const channelsInSelectedGroups = channels.filter(channel => selectedGroups.has(channel.group));
            const total = channelsInSelectedGroups.length;
            const valid = channelsInSelectedGroups.filter(c => c.valid === true).length;
            const invalid = channelsInSelectedGroups.filter(c => c.valid === false).length;
            const waiting = channelsInSelectedGroups.filter(c => c.valid === null).length;
            const filteredCount = getFilteredChannels(currentFilter).length;
            
            // 计算高清频道数量
            const hdChannels = channelsInSelectedGroups.filter(channel => 
                channel.valid === true && isHDChannel(channel)
            ).length;
            
            // 构建统计按钮HTML
            const statsHTML = `
                <span>筛选: </span>
                <button class="stats-btn stats-all ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">
                    全部 (${total})
                </button>
                <button class="stats-btn stats-valid ${currentFilter === 'valid' ? 'active' : ''}" data-filter="valid">
                    有效 (${valid})
                </button>
                <button class="stats-btn stats-invalid ${currentFilter === 'invalid' ? 'active' : ''}" data-filter="invalid">
                    无效 (${invalid})
                </button>
                <button class="stats-btn stats-waiting ${currentFilter === 'waiting' ? 'active' : ''}" data-filter="waiting">
                    等待 (${waiting})
                </button>
                <span> | 高清: ${hdChannels} | 超时: ${timeoutSeconds}秒 | 并发: ${concurrentLimit}个 | 显示: ${filteredCount}/${total}</span>
            `;
            
            elements.statsDiv.innerHTML = statsHTML;
            
            // 为统计按钮添加点击事件
            elements.statsDiv.querySelectorAll('.stats-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    applyFilter(filter);
                });
            });
            
            if (waiting === 0 && total > 0) elements.checkBtn.textContent = '重新检测';
        }
        
        async function startChecking() {
            if (isChecking || displayedChannels.length === 0) {
                console.log('无法开始检测:', { isChecking, displayedChannelsLength: displayedChannels.length });
                return;
            }
            
            isChecking = true;
            elements.checkBtn.disabled = true;
            elements.checkBtn.textContent = '检测中...';
            
            // 禁用滑块和分组按钮，防止在检测过程中更改设置
            elements.timeoutSlider.disabled = true;
            elements.concurrentSlider.disabled = true;
            elements.groupBtn.disabled = true;
            
            // 重置状态
            channels.forEach(channel => {
                if (selectedGroups.has(channel.group)) { 
                    channel.valid = null; 
                    channel.time = null; 
                    channel.resolution = null;
                    channel.resolutionClass = null;
                }
            });
            
            // 清空分辨率信息
            channelResolutions.clear();
            
            // 清空选中的频道
            selectedChannels.clear();
            updateSelectedCount();
            
            // 重置筛选为全部显示
            applyFilter('all');
            
            try {
                // 使用安全的并发检测
                await checkChannelsSafely();
                console.log('检测完成');
            } catch (error) {
                console.error('检测过程中发生错误:', error);
            } finally {
                // 确保清理所有视频元素
                cleanupAllVideoElements();
                
                isChecking = false;
                elements.checkBtn.disabled = false;
                elements.checkBtn.textContent = '重新检测';
                // 重新启用滑块和分组按钮
                elements.timeoutSlider.disabled = false;
                elements.concurrentSlider.disabled = false;
                elements.groupBtn.disabled = false;
                
                // 更新统计信息
                updateStats();
            }
        }
        
        // 添加点击事件监听器
        elements.checkBtn.addEventListener('click', function() {
            console.log('开始检测按钮被点击');
            startChecking();
        });
        
        // 批量操作按钮事件
        elements.selectValidBtn.addEventListener('click', selectAllValidChannels);
        elements.deselectAllBtn.addEventListener('click', deselectAllChannels);
        elements.exportSelectedBtn.addEventListener('click', exportSelectedChannels); // 新增按钮
        elements.exportHDChannelsBtn.addEventListener('click', exportHDChannels);
        elements.exportAllValidBtn.addEventListener('click', exportAllValidChannels);
        
        elements.groupBtn.addEventListener('click', showGroupModal);
        elements.closeModal.addEventListener('click', () => elements.groupModal.classList.remove('show'));
        elements.groupModal.addEventListener('click', (e) => e.target === elements.groupModal && elements.groupModal.classList.remove('show'));
        
        elements.selectAllGroupsBtn.addEventListener('click', () => {
            Object.keys(groups).forEach(group => selectedGroups.add(group));
            if (elements.groupList.querySelectorAll('.group-checkbox').length > 0) {
                elements.groupList.querySelectorAll('.group-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                    checkbox.closest('.group-item').classList.add('selected');
                });
                elements.selectedGroupsCount.textContent = selectedGroups.size;
                applyFilter('all');
            }
        });
        
        elements.deselectAllGroupsBtn.addEventListener('click', () => {
            selectedGroups.clear();
            if (elements.groupList.querySelectorAll('.group-checkbox').length > 0) {
                elements.groupList.querySelectorAll('.group-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.closest('.group-item').classList.remove('selected');
                });
                elements.selectedGroupsCount.textContent = selectedGroups.size;
                applyFilter('all');
            }
        });
        
        elements.clearBtn.addEventListener('click', () => {
            // 停止所有检测并清理视频元素
            if (isChecking) {
                cleanupAllVideoElements();
                isChecking = false;
            }
            
            elements.resultArea.innerHTML = '';
            elements.statsDiv.innerHTML = '';
            elements.filterInfo.innerHTML = '';
            elements.dropArea.innerHTML = '点击或拖拽m3u/txt文件到此处';
            elements.checkBtn.disabled = true;
            elements.groupBtn.disabled = true;
            elements.checkBtn.textContent = '开始检测';
            
            // 启用滑块
            elements.timeoutSlider.disabled = false;
            elements.concurrentSlider.disabled = false;
            
            // 清理所有视频元素
            cleanupAllVideoElements();
            
            channels = []; groups = {}; displayedChannels = []; selectedGroups.clear();
            selectedChannels.clear();
            channelResolutions.clear();
            activeVideoElements.clear();
            currentFilter = 'all';
            elements.fileInput.value = '';
            
            updateSelectedCount();
            
            // 强制垃圾回收提示
            if (window.gc) {
                window.gc();
            }
        });
        
        // 页面卸载时清理所有视频元素
        window.addEventListener('beforeunload', () => {
            cleanupAllVideoElements();
        });
        
        // 定期检查内存占用
        setInterval(() => {
            if (activeVideoElements.size > 0) {
                updateStats();
            }
        }, 2000);
    </script>
</body>
</html>
